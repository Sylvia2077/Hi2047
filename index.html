<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手机应用界面</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* 基础字体样式 */
        body {
            font-family: 'PingFang SC', 'Inter', sans-serif;
        }

        /* 字体大小调整 */
        #phone-screen {
            font-size: 15px; /* 中 (默认) */
            transition: font-size 0.2s ease-in-out;
        }
        #phone-screen.text-size-small {
            font-size: 13.5px; /* 小 */
        }
        #phone-screen.text-size-large {
            font-size: 16.5px; /* 大 */
        }
        
        /* 應用程式圖示互動效果 */
        .app-icon {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            background-size: cover;
            background-position: center;
        }
        .app-icon:hover {
            transform: scale(1.05);
        }
        .app-icon:active {
            transform: scale(0.95);
            box-shadow: none;
        }

        .app-icon-glass {
            background: rgba(55, 65, 81, 0.5); /* bg-gray-600 with 50% opacity */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* 訊息提示框樣式 */
        .message-box {
            position: absolute; /* 相對於父容器phone-screen定位 */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem 2rem;
            border-radius: 1rem;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 11000; /* Ensure it's above everything */
        }
        .message-box.show {
            opacity: 1;
            visibility: visible;
        }
        
        /* 淡入動畫 */
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hidden {
            display: none;
        }
        
        /* 黑膠唱片旋轉動畫 */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .record-spin {
            animation: spin 12s linear infinite; /* 調整旋轉速度 */
        }
        
        /* 隱藏文件輸入框 */
        #music-upload-input, #background-input, #vinyl-input, #widget-image-input, #photo-widget-input, #wallpaper-input, #character-avatar-input, #user-avatar-input, #chat-bg-input, #import-data-input, #image-upload-input, #user-video-image-input, #my-video-image-input {
            display: none;
        }
        
        .music-block-background {
            background-image: url('https://placehold.co/400x150/1a1a1a/ffffff?text=UPLOAD+BACKGROUND');
            background-size: cover;
            background-position: center;
            cursor: pointer;
        }
        
        .vinyl-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 100%;
            border-radius: 50%;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }
        
        .vinyl-image-container {
            position: absolute;
            inset: 0;
            margin: auto;
            width: 67%;
            height: 67%;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            background-image: url('https://placehold.co/100x100/000000/ffffff?text=UPLOAD');
            background-size: cover;
            background-position: center;
            cursor: pointer;
        }
        
        .vinyl-center {
            position: absolute;
            inset: 0;
            margin: auto;
            width: 1rem;
            height: 1rem;
            background-color: #f3f4f6;
            border-radius: 50%;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 9000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            width: 80%;
            max-width: 300px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            padding: 1rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .song-list-item {
            padding: 0.75rem 0.5rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: default;
        }
        .song-list-item:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .song-list-item.active {
            font-weight: 600;
            color: #ffffff;
        }
        .song-list-item-left {
            display: flex;
            align-items: center;
            flex-grow: 1;
            min-width: 0;
        }
        .song-list-item-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        .drag-handle {
            cursor: grab;
            padding-right: 0.75rem;
            color: #9ca3af;
        }
        .delete-button {
            cursor: pointer;
            transition: color 0.2s;
            padding-left: 0.75rem;
        }
        .delete-button.pending-delete {
            color: #ef4444;
        }

        .player-button {
            transition: color 0.2s;
        }

        .loop-button.active, .single-loop-button.active {
            color: #ffffff;
        }
        
        .text-widget-input {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            padding: 0.25rem 0;
        }
        
        .image-placeholder {
            background-color: rgba(255, 255, 255, 0.2);
            background-size: cover;
            background-position: center;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 日夜间模式样式 */
        .dark-mode {
            background-color: #333333;
            color: #ffffff;
        }
        .dark-mode .phone-frame { background-color: #1a1a1a; }
        .dark-mode .phone-screen { background-color: transparent; }
        .dark-mode #home-wallpaper { background-color: #000000; }
        .dark-mode .status-bar, .dark-mode .text-dark, .dark-mode .player-button i, .dark-mode #music-upload-button i, .dark-mode #mood-text::placeholder, .dark-mode #playlist-button i, .dark-mode .text-widget-input::placeholder, .dark-mode .app-header-btn, .dark-mode .quick-action-btn { color: #ffffff; }
        .dark-mode .status-bar { transition: background-color 0.3s; background-color: #1a1a1a; }
        .dark-mode .status-bar.on-home { background-color: transparent !important; }
        .dark-mode .dock, .dark-mode .music-block {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark-mode .app-screen-view:not(#home-screen):not(#wechat-chat-screen) { background-color: #1a1a1a; }
        .dark-mode #wechat-chat-screen { background-color: #1a1a1a; }
        .dark-mode .app-header { background-color: #1a1a1a; border-color: rgba(255, 255, 255, 0.15); }
        .dark-mode .wechat-tab-bar { background-color: #2c2c2c; border-color: #4a4a4a; }
        .dark-mode .image-placeholder { background-color: rgba(255, 255, 255, 0.2); }
        .dark-mode .bg-card { background-color: rgba(255, 255, 255, 0.08); }
        .dark-mode .settings-item, .dark-mode .list-item { background-color: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.15); }
        .dark-mode .wechat-list-item { border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .dark-mode .wechat-list-item:hover { background-color: rgba(255, 255, 255, 0.1); }
        .dark-mode .api-status-on { color: #ffffff; }
        .dark-mode .chat-input-btn { color: #d1d5db; }
        .dark-mode .chat-system-message { background-color: rgba(255, 255, 255, 0.1); }
        
        .light-mode { background-color: #f0f2f5; color: #1f2937; }
        .light-mode .phone-frame { background-color: #1a1a1a; }
        .light-mode .phone-screen { background-color: transparent; }
        .light-mode #home-wallpaper { background-image: linear-gradient(to bottom right, #e2e8f0, #f8fafc, #ffffff); }
        .light-mode .status-bar, .light-mode .text-dark, .light-mode .app-header-btn, .light-mode .quick-action-btn { color: #1f2937; }
        .light-mode .status-bar { transition: background-color 0.3s; background-color: #ffffff; }
        .light-mode .status-bar.on-home { background-color: transparent !important; }
        .light-mode .player-button i, .light-mode #music-upload-button i, .light-mode #playlist-button i, .light-mode .text-widget-input::placeholder { color: #1f2937; }
        .light-mode #mood-text { color: #1f2937; }
        .light-mode #mood-text::placeholder { color: #9ca3af; }
        .light-mode .dock, .light-mode .music-block {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .light-mode .app-screen-view:not(#home-screen):not(#wechat-chat-screen) { background-color: #f0f2f5; }
        .light-mode #wechat-chat-screen { background-color: #f0f2f5; }
        .light-mode .app-header { background-color: #ffffff; border-color: rgba(0, 0, 0, 0.1); }
        .light-mode .wechat-tab-bar { background-color: #ffffff; border-color: #e5e7eb; }
        .light-mode .image-placeholder { background-color: rgba(0, 0, 0, 0.1); }
        .light-mode .bg-card { background-color: #ffffff; }
        .light-mode .settings-item, .light-mode .list-item { background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .light-mode .wechat-list-item { border-bottom: 1px solid rgba(0, 0, 0, 0.08); }
        .light-mode .wechat-list-item:hover { background-color: rgba(0, 0, 0, 0.05); }
        .light-mode .api-status-on { color: #1f2937; }
        .light-mode .chat-input-btn { color: #4b5563; }
        .light-mode .chat-system-message { background-color: rgba(0, 0, 0, 0.1); }

        /* 聊天界面样式 */
        #wechat-content-chat {
            padding-top: 0.5rem;
        }
        #wechat-content-chat .chat-message-wrapper.new-sender:first-child {
            margin-top: 0.5rem;
        }
        .chat-message-wrapper {
            display: flex;
            align-items: flex-start;
            width: 100%;
            position: relative;
        }
        .chat-message-wrapper.sent {
            justify-content: flex-end;
        }
        .chat-message-wrapper.received {
            justify-content: flex-start;
        }
        .chat-message-wrapper + .chat-message-wrapper {
            margin-top: 0.25rem; 
        }
        .chat-message-wrapper.new-sender {
            margin-top: 1rem;
        }
        .chat-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: #9ca3af;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.5);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-avatar i {
            font-size: 22px;
            color: rgba(255, 255, 255, 0.8);
        }
        .light-mode .chat-avatar i {
             color: rgba(0, 0, 0, 0.6);
        }
        .chat-message-content {
            display: flex;
            flex-direction: column;
            min-width: 0;
            margin: 0 0.5rem;
            max-width: 75%;
        }
        .chat-message-wrapper.sent .chat-message-content { align-items: flex-end; }
        .chat-message-wrapper.received .chat-message-content { align-items: flex-start; }
        .chat-message {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 1.25rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: background-color 0.3s;
            position: relative;
            padding: 0.5rem 1rem;
            width: -moz-fit-content;
            width: fit-content;
            max-width: 100%; 
            cursor: pointer;
        }
        .chat-message.image-message {
            padding: 0.25rem;
            background-color: transparent !important;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .chat-message.image-message img {
            max-width: 150px;
            max-height: 200px;
            border-radius: 1rem;
            display: block;
        }
        .chat-message.voice-message {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .voice-main {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .voice-play-icon {
            font-size: 1.25rem;
        }
        .voice-duration {
            font-size: 0.8em;
            white-space: nowrap;
        }
        .voice-text {
            padding-top: 0.5rem;
            margin-top: 0.5rem;
            border-top: 1px solid rgba(128, 128, 128, 0.2);
            font-size: 0.9em;
            display: none;
        }
        .chat-message p, .chat-message i {
            font-size: inherit;
            line-height: 1.5;
        }
        .chat-message::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 60%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.15), rgba(255,255,255,0));
            border-radius: 1.25rem 1.25rem 0 0;
            pointer-events: none;
        }
        .light-mode .chat-message::before {
             background: linear-gradient(to bottom, rgba(255,255,255,0.4), rgba(255,255,255,0));
        }
        .chat-message.image-message::before, .chat-message.voice-message::before {
            display: none;
        }
        .chat-message::after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 12px;
            height: 12px;
            background: var(--bubble-bg);
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 12C5.33333 12 12 5.33333 12 0C12 5.33333 5.33333 12 0 12Z' fill='%23C4C4C4'/%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 12C5.33333 12 12 5.33333 12 0C12 5.33333 5.33333 12 0 12Z' fill='%23C4C4C4'/%3E%3C/svg%3E");
        }
        .chat-message.image-message::after {
            display: none;
        }
        .chat-message.sent::after {
            right: -6px;
            transform: scaleX(-1);
        }
        .chat-message.received::after {
            left: -6px;
        }
        .message-meta {
            font-size: 0.65rem;
            color: #9ca3af;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            margin-bottom: 5px;
            white-space: nowrap;
            align-self: flex-end;
        }
        .chat-message-wrapper.sent .message-meta {
            align-items: flex-end;
        }
        .chat-message-wrapper.received .message-meta {
            align-items: flex-start;
        }
        .message-read-status {
            margin-left: 0;
            display: none;
        }
        .message-read-status.visible {
            display: inline;
        }
        .dark-mode .chat-message { border: 1px solid rgba(255, 255, 255, 0.1); }
        .light-mode .chat-message { border: 1px solid rgba(0, 0, 0, 0.05); }
        .dark-mode .chat-message.sent { background-color: rgba(219, 39, 119, 0.3); }
        .dark-mode .chat-message.received { background-color: rgba(74, 74, 74, 0.3); }
        .light-mode .chat-message.sent { background-color: rgba(249, 168, 212, 0.4); }
        .light-mode .chat-message.received { background-color: rgba(229, 231, 250, 0.6); }
        .dark-mode .chat-message.sent.image-message, .light-mode .chat-message.sent.image-message { border: 2px solid rgba(249, 168, 212, 0.6); }
        .dark-mode .chat-message.received.image-message, .light-mode .chat-message.received.image-message { border: 2px solid rgba(229, 231, 250, 0.8); }
        .chat-system-message {
            background-color: rgba(128, 128, 128, 0.2);
            color: #d1d5db;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            margin: 0.5rem auto;
            width: fit-content;
        }
        .light-mode .chat-system-message {
            color: #4b5563;
        }
        .chat-input-bar {
            background-color: transparent;
            border-top-width: 1px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .dark-mode .chat-input-bar { border-color: rgba(255, 255, 255, 0.1); }
        .light-mode .chat-input-bar { border-color: rgba(0, 0, 0, 0.1); }
        #chat-input {
            border: 1px solid transparent;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.3s, box-shadow 0.3s, height 0.2s ease-in-out;
            resize: none;
            overflow-y: auto;
            line-height: 1.5;
        }
        .dark-mode #chat-input { background-color: rgba(31, 41, 55, 0.8); color: #ffffff; }
        .light-mode #chat-input { background-color: rgba(243, 244, 246, 0.8); color: #1f2937; }
        .status-bar.transparent-override {
            background-color: transparent !important;
        }
        #wechat-chat-screen.has-custom-bg {
            background-color: transparent !important;
        }
        #wechat-chat-screen.has-custom-bg .app-header,
        #wechat-chat-screen.has-custom-bg .chat-input-bar,
        #wechat-chat-screen.has-custom-bg #chat-quick-actions-bar {
            background: transparent !important;
            border-color: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }
        #wechat-chat-screen.has-custom-bg #chat-input {
            background-color: rgba(0,0,0,0.2);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
        }
        .light-mode #wechat-chat-screen.has-custom-bg #chat-input {
             background-color: rgba(255,255,255,0.2);
             box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .chat-time-divider {
            display: none;
        }
        
        .bubble-context-menu {
            position: absolute;
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 2rem;
            padding: 2px 4px;
            display: none;
            flex-direction: row;
            align-items: center;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateY(5px) scale(0.95);
            opacity: 0;
            transition: opacity 0.15s ease-out, transform 0.15s ease-out;
            visibility: hidden;
        }
        .bubble-context-menu.visible {
            display: flex;
            opacity: 1;
            transform: translateY(0) scale(1);
            visibility: visible;
        }
        .bubble-menu-button {
            background: none;
            border: none;
            color: #f0f0f0;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 11px;
            border-radius: 2rem;
            transition: background-color 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
        }
        .bubble-menu-button:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .bubble-menu-button:disabled {
            color: #6b7280;
            cursor: not-allowed;
        }
        .bubble-menu-button i {
            font-size: 12px;
            margin-right: 3px;
        }
        
        .chat-message-wrapper.selected .chat-message {
            background-color: rgba(59, 130, 246, 0.4) !important;
            border-color: rgba(96, 165, 250, 0.8) !important;
        }
        .light-mode .chat-message-wrapper.selected .chat-message {
             background-color: rgba(96, 165, 250, 0.5) !important;
        }


        .color-picker-input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 1.75rem;
            height: 1.75rem;
            padding: 0;
            border: 2px solid rgba(128, 128, 128, 0.3);
            border-radius: 50%;
            cursor: pointer;
            background-color: transparent;
        }
        .color-picker-input::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .color-picker-input::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
        }
        .color-picker-input::-moz-color-swatch {
            border: none;
            border-radius: 50%;
        }

        .app-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0.5rem 1rem;
            border-bottom-width: 1px; 
            height: 3rem;
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            transition: background-color 0.3s, border-color 0.3s;
            flex-shrink: 0;
            z-index: 10;
        }
        .light-mode .app-header {
            border-color: rgba(0, 0, 0, 0.08);
        }

        .app-header-title { 
            font-weight: 700; 
            font-size: 1.125em;
            position: relative;
            top: 2px;
        }
        .app-header-title.clickable { cursor: pointer; }
        .app-header-btn.text-pink-500 {
            color: #d1d5db;
        }
        .app-header-btn { font-size: 1.25em; }

        .list-item {
            padding: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 1rem;
            position: relative;
        }
        .list-item:hover {
            background-color: rgba(128, 128, 128, 0.1);
        }
        .list-item-delete-btn {
            position: absolute;
            top: -0.5rem;
            left: -0.5rem;
            width: 1.5rem;
            height: 1.5rem;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            z-index: 10;
            animation: popIn 0.2s ease-out;
        }
        .deletable:hover .list-item-delete-btn {
            display: flex;
        }
        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }


        .form-input, .form-textarea, .form-select { width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid transparent; }
        .dark-mode .form-input, .dark-mode .form-textarea, .dark-mode .form-select { background-color: #2c2c2c; color: #ffffff; }
        .light-mode .form-input, .light-mode .form-textarea, .light-mode .form-select { background-color: #ffffff; color: #1f2937; border: 1px solid #e5e7eb; }
        .wb-checkbox-label { display: flex; align-items: center; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; }
        .wb-checkbox-label:hover { background-color: rgba(255, 255, 255, 0.1); }
        .wb-checkbox-label input { margin-right: 0.75rem; }

        .wechat-tab-bar { display: flex; border-top-width: 1px; }
        .wechat-tab-item { flex: 1; text-align: center; padding: 0.5rem 0; cursor: pointer; color: #9ca3af; }
        .wechat-tab-item.active {
            font-weight: 600;
        }
        .dark-mode .wechat-tab-item.active {
            color: #ffffff;
        }
        .light-mode .wechat-tab-item.active {
            color: #1f2937;
        }
        .wechat-tab-item i { font-size: 1.25em; }
        .wechat-tab-item span { display: block; font-size: 0.75em; }

        .wechat-list-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        .wechat-list-item .last-message {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .user-avatar-in-chat {
            cursor: pointer;
        }

        .app-screen-view { 
            height: 100%;
            padding-top: 3rem;
        }


        .font-size-btn.active {
            font-weight: 600;
        }
        .dark-mode .font-size-btn.active { background-color: #52525b; }
        .light-mode .font-size-btn.active { background-color: #d4d4d8; }
        .dark-mode #font-size-selector { background-color: #3f3f46; }
        .light-mode #font-size-selector { background-color: #e4e4e7; }

        #confirm-delete-modal .modal-content {
            padding: 1.5rem;
        }
        
        .chat-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: -1;
        }
        
        #chat-quick-actions-bar {
            background: transparent;
            padding: 0.25rem 1rem;
            display: flex;
            justify-content: flex-start;
            gap: 1rem;
        }
        .quick-action-btn {
            font-size: 1.25rem;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .quick-action-btn:hover {
            opacity: 1;
        }
        
        #chat-footer {
            position: relative;
        }

        #chat-input-bar {
            padding: 0.5rem 0.25rem;
        }
        #chat-input-bar .chat-input-btn {
            font-size: 1.25rem;
            padding: 0.5rem;
            flex-shrink: 0;
        }
        #emoji-btn {
            margin-left: -0.25rem;
        }

        #more-features-panel {
            background: #2c2c2e;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }
        .light-mode #more-features-panel {
            background: #f8f8f8;
            border-top-color: rgba(0, 0, 0, 0.1);
        }
        .features-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
        .feature-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        .feature-icon-wrapper {
            width: 56px;
            height: 56px;
            border-radius: 1rem;
            background-color: #3a3a3c;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s;
        }
        .light-mode .feature-icon-wrapper {
            background-color: #ffffff;
        }
        .feature-item:hover .feature-icon-wrapper {
            background-color: #555;
        }
        .light-mode .feature-item:hover .feature-icon-wrapper {
            background-color: #e5e5e5;
        }
        .feature-icon-wrapper i {
            font-size: 1.5rem;
        }
        .feature-item span {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .call-screen {
            position: absolute;
            inset: 0;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            background-color: #111;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .call-screen.visible {
            opacity: 1;
            visibility: visible;
        }
        .call-background {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            filter: blur(4px) brightness(0.6);
            transform: scale(1.1);
        }
        .call-content {
            position: relative;
            z-index: 1;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 3.5rem 1rem 1rem;
        }
        #voice-call-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid rgba(255,255,255,0.5);
            object-fit: cover;
            box-shadow: 0 0 30px rgba(255,255,255,0.3);
            margin-top: 2rem;
        }
        #user-video-preview {
            position: absolute;
            top: 3.5rem;
            right: 1rem;
            width: 90px;
            height: 120px;
            background-color: #333;
            border-radius: 1rem;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #user-video-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .call-status-box {
            margin-top: 1rem;
            background: rgba(0, 0, 0, 0.25); 
            backdrop-filter: blur(12px);     
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 1rem;
            padding: 1rem;
            max-height: 25vh;
            overflow-y: auto;
            font-style: italic;
            color: #e5e7eb;
            flex-shrink: 0;
        }
        .call-input-area {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem 0;
        }
        .call-input-area textarea {
            flex-grow: 1;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1.5rem;
            padding: 0.5rem 1rem;
            color: white;
            resize: none;
        }
        .call-input-area button {
            background-color: #374151;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            flex-shrink: 0;
            transition: background-color 0.2s;
        }
        .call-input-area button:hover {
            background-color: #4b5563;
        }
        .call-controls {
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding: 1rem 0;
        }
        .call-control-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
        }
        .hangup-btn { background-color: #ef4444; }

        #incoming-call-alert {
            position: absolute;
            top: 3.5rem;
            left: 0.5rem;
            right: 0.5rem;
            z-index: 9500;
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 1.5rem;
            padding: 1rem;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            transform: translateY(-200%);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        #incoming-call-alert.visible {
            transform: translateY(0);
        }
        #incoming-call-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 1rem;
        }
        #incoming-call-info {
            flex-grow: 1;
        }
        .call-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 1.25rem;
            margin-left: 0.75rem;
        }
        #answer-call-btn { background-color: #22c55e; }
        #decline-call-btn { background-color: #ef4444; }

    </style>
</head>
<body class="flex items-center justify-center min-h-screen dark-mode">
    
    <input type="file" id="user-avatar-input" class="hidden" accept="image/*">
    <input type="file" id="chat-bg-input" class="hidden" accept="image/*">
    <input type="file" id="import-data-input" class="hidden" accept=".json">
    <input type="file" id="image-upload-input" class="hidden" accept="image/*">
    <input type="file" id="user-video-image-input" class="hidden" accept="image/*">
    <input type="file" id="my-video-image-input" class="hidden" accept="image/*">
    <div class="phone-frame relative w-full max-w-[375px] h-[720px] rounded-[3rem] p-2 shadow-2xl flex flex-col overflow-hidden transform transition-all duration-300">
        
        <div id="phone-screen" class="phone-screen flex-1 rounded-[2.5rem] overflow-hidden relative animate-fade-in">
            
            <div id="home-wallpaper" class="absolute inset-0 w-full h-full bg-cover bg-center z-0"></div>

            <div id="status-bar" class="status-bar absolute top-0 left-0 right-0 z-50 px-5 py-3 text-sm font-semibold flex justify-between items-center transition-colors">
                <div class="flex items-center space-x-2">
                    <span id="currentTime">12:45</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="api-status-text" class="text-red-500">API OFF</span>
                    <button id="theme-toggle" class="p-1 rounded-full hover:bg-white/20 transition-colors">
                        <i id="theme-icon" class="fas fa-moon text-lg"></i>
                    </button>
                </div>
            </div>

            <div id="messageBox" class="message-box"></div>
            
            <div id="song-list-modal" class="modal-overlay">
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white">播放列表</h3>
                        <button id="close-playlist-modal" class="text-white text-2xl p-1 rounded-full hover:bg-white/20">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <ul id="song-list-container" class="space-y-2 max-h-60 overflow-y-auto">
                        </ul>
                </div>
            </div>
            <div id="new-chat-modal" class="modal-overlay">
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white">发起新聊天</h3>
                        <button id="close-new-chat-modal" class="text-white text-2xl p-1 rounded-full hover:bg-white/20">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <ul id="new-chat-character-list" class="space-y-2 max-h-60 overflow-y-auto">
                        </ul>
                </div>
            </div>
             <div id="confirm-delete-modal" class="modal-overlay">
                <div class="modal-content text-center text-white">
                    <h3 id="delete-modal-title" class="text-lg font-bold mb-4">确认删除吗？</h3>
                    <p id="delete-modal-text" class="text-sm mb-6">此操作无法撤销。</p>
                    <div class="flex justify-around">
                        <button id="cancel-delete-btn" class="px-6 py-2 rounded-lg">取消</button>
                        <button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg">删除</button>
                    </div>
                </div>
            </div>
            <div id="voice-input-modal" class="modal-overlay">
                <div class="modal-content">
                    <h3 class="text-lg font-bold mb-4 text-center">发送语音消息</h3>
                    <textarea id="voice-text-input" class="form-textarea w-full h-24 resize-none" placeholder="在此输入文字..."></textarea>
                    <div class="flex justify-end mt-4 gap-2">
                        <button id="cancel-voice-btn" class="px-4 py-2 rounded-lg">取消</button>
                        <button id="send-voice-btn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg">发送</button>
                        </div>
                </div>
            </div>


            <div id="home-screen" class="app-screen-view relative">
                <div id="music-block-container" class="p-2 mt-2">
                    <div id="music-block" class="music-block relative w-full p-3 rounded-2xl flex items-center justify-between shadow-xl music-block-background">
                        <div class="relative w-1/2 flex-shrink-0 flex items-center justify-center">
                            <div id="vinyl-container" class="vinyl-container">
                                <div id="vinyl-record" class="vinyl-image-container">
                                    <div id="vinyl-center" class="vinyl-center"></div>
                                </div>
                            </div>
                            <input type="file" id="background-input" accept="image/*">
                            <input type="file" id="vinyl-input" accept="image/*">
                            <input type="file" id="music-upload-input" accept="audio/*,.mp3,.m4a,.wav,.ogg,.flac" multiple>
                        </div>
                        <div class="flex-grow flex flex-col justify-center h-24 ml-4">
                            <textarea id="mood-text" class="w-full bg-transparent placeholder-gray-300 text-sm p-1 rounded-md resize-none border-none outline-none focus:ring-2 focus:ring-white/50 focus:bg-white/10 transition-all text-center" placeholder="点击填写心情..."></textarea>
                            <div class="flex items-center justify-center space-x-3 mt-2">
                                <button id="loop-button" class="player-button"><i class="fas fa-rotate-right text-base"></i></button>
                                <button id="prev-button" class="player-button"><i class="fas fa-step-backward text-base"></i></button>
                                <button id="play-pause-button" class="player-button"><i class="fas fa-play text-xl"></i></button>
                                <button id="next-button" class="player-button"><i class="fas fa-step-forward text-base"></i></button>
                                <button id="single-loop-button" class="player-button"><i class="fas fa-repeat text-base"></i></button>
                            </div>
                        </div>
                        <div class="absolute bottom-2 right-2 flex space-x-2">
                            <div id="playlist-button" class="p-1 rounded-full cursor-pointer hover:bg-white/30 transition-colors"><i class="fas fa-list text-sm"></i></div>
                            <div id="music-upload-button" class="p-1 rounded-full cursor-pointer hover:bg-white/30 transition-colors"><i class="fas fa-music text-sm"></i></div>
                        </div>
                    </div>
                </div>
                <div class="px-4 grid grid-cols-2 gap-4 mt-2">
                    <div id="photo-widget" class="w-full aspect-square rounded-2xl shadow-xl flex items-center justify-center transition-colors duration-300 cursor-pointer bg-cover bg-center">
                        <span id="photo-widget-text" class="text-2xl font-bold text-white/80">照片墙</span>
                    </div>
                    <input type="file" id="photo-widget-input" accept="image/*">
                    <div id="text-input-widget" class="w-full aspect-square p-4 flex flex-col justify-center transition-colors duration-300">
                        <div class="flex items-center mb-3">
                            <div id="widget-image-placeholder" class="w-10 h-10 rounded-full flex-shrink-0 mr-3 image-placeholder">
                                <i class="fas fa-camera"></i>
                            </div>
                            <input type="text" id="widget-name-input" placeholder="Name" class="text-widget-input text-base border-0 focus:ring-2 focus:ring-white/50">
                            <input type="file" id="widget-image-input" accept="image/*">
                        </div>
                        <input type="text" id="widget-thinking-input" placeholder="Thinking..." class="text-widget-input text-xs mb-3 border-0 focus:ring-2 focus:ring-white/50">
                        <div class="flex items-center">
                            <i class="fas fa-map-marker-alt text-xs mr-2 opacity-80"></i>
                            <input type="text" id="widget-location-input" placeholder="Where r u" class="text-widget-input text-xs border-0 focus:ring-2 focus:ring-white/50">
                        </div>
                    </div>
                </div>
                
                <div class="px-4 grid grid-cols-2 gap-4 mt-4">
                    <div></div> 
                    <div class="grid grid-cols-2 gap-4">
                        <div class="w-14 h-14 rounded-xl flex items-center justify-center shadow-lg app-icon app-icon-glass" data-app-name="Placeholder 1"><i class="fas fa-question text-white text-2xl"></i></div>
                        <div class="w-14 h-14 rounded-xl flex items-center justify-center shadow-lg app-icon app-icon-glass" data-app-name="设置"><i class="fas fa-cog text-white text-2xl"></i></div>
                        <div class="w-14 h-14 rounded-xl flex items-center justify-center shadow-lg app-icon app-icon-glass" data-app-name="Placeholder 2"><i class="fas fa-question text-white text-2xl"></i></div>
                        <div class="w-14 h-14 rounded-xl flex items-center justify-center shadow-lg app-icon app-icon-glass" data-app-name="Placeholder 3"><i class="fas fa-question text-white text-2xl"></i></div>
                        </div>
                </div>

                <div class="dock absolute bottom-4 left-1/2 -translate-x-1/2 w-[90%] max-w-[340px] h-18 rounded-3xl p-2 flex items-center justify-around shadow-xl">
                    <div class="flex flex-col items-center"><div class="w-14 h-14 bg-zinc-800 rounded-xl flex items-center justify-center shadow-lg app-icon" data-app-name="世界书"><i class="fas fa-book text-white text-2xl"></i></div></div>
                    <div class="flex flex-col items-center"><div class="w-14 h-14 bg-zinc-800 rounded-xl flex items-center justify-center shadow-lg app-icon" data-app-name="角色书"><i class="fas fa-theater-masks text-white text-2xl"></i></div></div>
                    <div class="flex flex-col items-center"><div class="w-14 h-14 bg-zinc-800 rounded-xl flex items-center justify-center shadow-lg app-icon" data-app-name="微信"><i class="fab fa-weixin text-white text-2xl"></i></div></div>
                </div>
            </div>

            <div id="wechat-list-screen" class="app-screen-view flex-col hidden">
                <div class="app-header">
                    <button id="wechat-list-back-button" class="app-header-btn"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="wechat-list-title" class="app-header-title">WeChat</h3>
                    <button id="wechat-new-chat-button" class="app-header-btn"><i class="fas fa-plus"></i></button>
                </div>
                <div id="wechat-list-container" class="flex-1 overflow-y-auto">
                    </div>
                 <div class="wechat-tab-bar">
                    <div class="wechat-tab-item active" data-tab="chat">
                        <i class="ri-chat-heart-line"></i>
                        <span>聊天</span>
                    </div>
                    <div class="wechat-tab-item" data-tab="moments">
                        <i class="ri-polaroid-2-line"></i>
                        <span>动态</span>
                    </div>
                    <div class="wechat-tab-item" data-tab="diary">
                        <i class="ri-quill-pen-line"></i>
                        <span>日记</span>
                    </div>
                    <div class="wechat-tab-item" data-tab="plan">
                        <i class="ri-suitcase-3-line"></i>
                        <span>计划</span>
                    </div>
                </div>
            </div>

            <div id="wechat-chat-screen" class="app-screen-view flex-col hidden">
                <div class="chat-background"></div>
                <div class="app-header">
                    <div id="chat-header-normal" class="flex items-center justify-between w-full">
                        <button id="wechat-chat-back-button" class="app-header-btn"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="wechat-contact-name" class="app-header-title"></h3>
                        <button id="wechat-options-button" class="app-header-btn"><i class="fas fa-ellipsis-h"></i></button>
                    </div>
                    <div id="chat-header-multiselect" class="hidden items-center justify-between w-full text-sm">
                        <button id="cancel-multiselect-btn" class="font-semibold px-2 py-1">取消</button>
                        <span id="multiselect-count" class="font-bold">已选择 0 项</span>
                        <button id="confirm-multiselect-btn" class="font-semibold text-red-500 px-2 py-1">删除</button>
                    </div>
                </div>
                <template id="bubble-menu-template">
                    <div class="bubble-context-menu">
                        <button data-action="delete" class="bubble-menu-button"><i class="fas fa-trash"></i><span>删除</span></button>
                        <button data-action="copy" class="bubble-menu-button"><i class="fas fa-copy"></i><span>复制</span></button>
                        <button data-action="multiselect" class="bubble-menu-button"><i class="fas fa-check-square"></i><span>多选</span></button>
                        <button data-action="edit" class="bubble-menu-button"><i class="fas fa-pencil-alt"></i><span>编辑</span></button>
                        <button data-action="retry" class="bubble-menu-button"><i class="fas fa-sync-alt"></i><span>重生成</span></button>
                    </div>
                </template>
                <div id="incoming-call-alert">
                    <img id="incoming-call-avatar" src="https://placehold.co/96x96/777/FFF?text=?" alt="avatar">
                    <div id="incoming-call-info">
                        <p id="incoming-call-name" class="font-bold">Character Name</p>
                        <p id="incoming-call-type" class="text-sm text-gray-300">正在呼叫...</p>
                    </div>
                    <button id="answer-call-btn" class="call-btn"><i class="ri-phone-fill"></i></button>
                    <button id="decline-call-btn" class="call-btn"><i class="ri-phone-fill rotate-135"></i></button>
                </div>
                <div id="wechat-content-chat" class="flex-1 overflow-y-auto p-4 space-y-1">
                    </div>
                
                <div id="chat-quick-actions-bar">
                    <button id="quick-voice-message-btn" class="quick-action-btn"><i class="ri-mic-line"></i></button>
                    <button id="quick-voice-call-btn" class="quick-action-btn"><i class="ri-phone-line"></i></button>
                    <button id="quick-video-call-btn" class="quick-action-btn"><i class="ri-vidicon-line"></i></button>
                </div>

                <div id="chat-footer">
                    <div id="chat-input-bar" class="chat-input-bar flex items-center p-2">
                        <button id="add-feature-btn" class="chat-input-btn"><i class="ri-add-circle-line"></i></button>
                        <button id="emoji-btn" class="chat-input-btn"><i class="ri-emotion-happy-line"></i></button>
                        <textarea id="chat-input" placeholder="输入信息..." class="chat-input flex-1 rounded-full px-4 py-2 mx-2 focus:ring-2 focus:ring-gray-500" rows="1"></textarea>
                        <button id="send-chat-button" class="chat-input-btn"><i class="far fa-paper-plane"></i></button>
                        <button id="receive-chat-button" class="chat-input-btn"><i class="fas fa-circle-notch"></i></button>
                    </div>

                    <div id="more-features-panel" class="hidden">
                        <div class="features-grid">
                            <div id="send-image-btn" class="feature-item">
                                <div class="feature-icon-wrapper"><i class="ri-image-line"></i></div>
                                <span>图片</span>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon-wrapper"><i class="ri-red-packet-line"></i></div>
                                <span>红包</span>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon-wrapper"><i class="ri-exchange-dollar-line"></i></div>
                                <span>转账</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="wechat-options-screen" class="app-screen-view flex-col hidden">
                <div class="app-header">
                    <button id="wechat-options-back-button" class="app-header-btn"><i class="fas fa-chevron-left"></i></button>
                    <h3 class="app-header-title">聊天设置</h3>
                    <div class="w-8"></div>
                </div>
                <div class="flex-1 p-2 overflow-y-auto space-y-2">
                    <div id="pin-chat-option" class="list-item">置顶对话</div>
                    <div id="change-chat-bg-option" class="list-item">设置聊天背景</div>
                    <div class="list-item flex justify-between items-center">
                        <span>气泡颜色 (我 / 对方)</span>
                        <div class="flex items-center space-x-3">
                            <input type="color" id="user-bubble-color-picker" class="color-picker-input">
                            <input type="color" id="ai-bubble-color-picker" class="color-picker-input">
                        </div>
                    </div>
                    <div id="change-user-video-image-option" class="list-item">设置对方的视频照片</div>
                    <div id="delete-chat-option" class="list-item text-red-500 mt-4">删除此对话</div>
                </div>
            </div>


            <div id="world-book-list-screen" class="app-screen-view flex-col hidden">
                <div class="app-header">
                    <button id="wb-list-back-button" class="app-header-btn"><i class="fas fa-chevron-left"></i></button>
                    <h3 class="app-header-title">世界书</h3>
                    <button id="wb-add-button" class="app-header-btn"><i class="fas fa-plus"></i></button>
                </div>
                <div id="world-book-list-container" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
            </div>

            <div id="world-book-edit-screen" class="app-screen-view flex-col hidden">
                <div class="app-header">
                    <button id="wb-edit-back-button" class="app-header-btn"><i class="fas fa-chevron-left"></i></button>
                    <h3 class="app-header-title">编辑世界书</h3>
                    <button id="wb-save-button" class="app-header-btn text-gray-300 font-bold text-base">保存</button>
                    </div>
                <div class="p-2 space-y-4">
                    <input type="text" id="wb-title-input" placeholder="标题" class="form-input">
                    <textarea id="wb-content-input" placeholder="内容..." class="form-textarea h-64 resize-none"></textarea>
                </div>
            </div>

            <div id="character-book-list-screen" class="app-screen-view flex-col hidden">
                <div class="app-header">
                    <button id="cb-list-back-button" class="app-header-btn"><i class="fas fa-chevron-left"></i></button>
                    <h3 class="app-header-title">角色书</h3>
                    <button id="cb-add-button" class="app-header-btn"><i class="fas fa-plus"></i></button>
                </div>
                <div id="character-book-list-container" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
            </div>

            <div id="character-book-edit-screen" class="app-screen-view flex-col hidden">
                <div class="app-header">
                    <button id="cb-edit-back-button" class="app-header-btn"><i class="fas fa-chevron-left"></i></button>
                    <h3 class="app-header-title">编辑角色</h3>
                    <button id="cb-save-button" class="app-header-btn text-gray-300 font-bold text-base">保存</button>
                    </div>
                <div class="flex-1 overflow-y-auto p-2 space-y-4">
                    <div class="flex items-center space-x-4 p-2">
                        <div id="character-avatar-placeholder" class="w-20 h-20 rounded-full flex-shrink-0 image-placeholder bg-cover bg-center">
                            <i class="fas fa-camera text-2xl"></i>
                        </div>
                        <input type="file" id="character-avatar-input" accept="image/*">
                        <div class="flex-grow">
                             <label class="block text-sm font-medium mb-1">角色姓名</label>
                             <input type="text" id="cb-name-input" class="form-input">
                        </div>
                    </div>
                     <div class="p-2">
                        <label class="block text-sm font-medium mb-1">角色设定 (性格、记忆、说话风格等)</label>
                        <textarea id="cb-persona-input" class="form-textarea h-24 resize-none"></textarea>
                    </div>
                    <div class="p-2">
                        <label class="block text-sm font-medium mb-1">我的设定 (我与角色的关系)</label>
                        <textarea id="cb-my-persona-input" class="form-textarea h-16 resize-none"></textarea>
                    </div>
                    <div class="p-2">
                        <label class="block text-sm font-medium mb-1">关联世界书 (可多选)</label>
                        <div id="cb-worldbook-select" class="space-y-1 max-h-24 overflow-y-auto p-2 rounded-lg border">
                            </div>
                    </div>
                    <div class="p-2">
                        <button id="cb-delete-button" class="w-full mt-4 px-4 py-2 bg-red-600 text-white rounded-md hidden">删除角色</button>
                    </div>
                </div>
            </div>
            
            <div id="main-settings-screen" class="app-screen-view main-settings-screen flex-col hidden">
                <div class="app-header">
                    <button id="main-settings-back-button" class="app-header-btn"><i class="fas fa-chevron-left"></i></button>
                    <h3 class="app-header-title flex-grow text-center">设置</h3>
                </div>
                <div class="settings-content flex-1 p-2 overflow-y-auto">
                    <div class="space-y-2">
                        <div id="api-settings-link" class="list-item flex justify-between items-center">
                            <div class="flex items-center">
                               <i class="fas fa-key w-6 text-center mr-3"></i>
                               <h4 class="font-semibold">API 设定</h4>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-2 mt-8">
                        <div id="beautify-settings-link" class="list-item flex justify-between items-center">
                            <div class="flex items-center">
                               <i class="fas fa-palette w-6 text-center mr-3"></i>
                               <h4 class="font-semibold">美化设置</h4>
                            </div>
                        </div>
                         <div id="font-settings-link" class="list-item flex justify-between items-center">
                            <div class="flex items-center">
                               <i class="fas fa-font w-6 text-center mr-3"></i>
                               <h4 class="font-semibold">字体设置</h4>
                            </div>
                        </div>
                    </div>
                     <div class="space-y-2 mt-8">
                        <div id="export-data-btn" class="list-item flex justify-between items-center">
                            <div class="flex items-center">
                               <i class="fas fa-download w-6 text-center mr-3"></i>
                               <h4 class="font-semibold">一键导出所有资料</h4>
                            </div>
                        </div>
                         <div id="import-data-btn" class="list-item flex justify-between items-center">
                            <div class="flex items-center">
                               <i class="fas fa-upload w-6 text-center mr-3"></i>
                               <h4 class="font-semibold">一键上传所有资料</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="beautify-settings-screen" class="app-screen-view beautify-settings-screen flex-col hidden">
                <div class="app-header">
                    <button id="beautify-settings-back-button" class="app-header-btn"><i class="fas fa-chevron-left"></i></button>
                    <h3 class="app-header-title flex-grow text-center">美化设置</h3>
                </div>
                <div class="settings-content flex-1 p-2 overflow-y-auto space-y-2">
                    <div id="change-wallpaper-link" class="list-item flex justify-between items-center">
                        <h4 class="font-semibold">更换手机壁纸</h4>
                    </div>
                    <input type="file" id="wallpaper-input" accept="image/*">
                    <div id="change-app-icons-link" class="list-item flex justify-between items-center">
                        <h4 class="font-semibold">更换App图标</h4>
                    </div>
                </div>
            </div>

             <div id="app-icon-settings-screen" class="app-screen-view app-icon-settings-screen flex-col hidden">
                <div class="app-header">
                    <button id="app-icon-settings-back-button" class="app-header-btn"><i class="fas fa-chevron-left"></i></button>
                    <h3 class="app-header-title flex-grow text-center">更换App图标</h3>
                </div>
                <div id="app-icon-list" class="settings-content flex-1 p-2 overflow-y-auto space-y-2">
                    </div>
            </div>

            <div id="font-settings-screen" class="app-screen-view font-settings-screen flex-col hidden">
                <div class="app-header">
                    <button id="font-settings-back-button" class="app-header-btn"><i class="fas fa-chevron-left"></i></button>
                    <h3 class="app-header-title flex-grow text-center">字体设置</h3>
                </div>
                <div class="settings-content flex-1 p-2 overflow-y-auto space-y-4">
                    <div class="p-4 rounded-lg bg-card">
                        <label class="block text-sm font-medium mb-2">文字大小</label>
                        <div id="font-size-selector" class="flex justify-between rounded-lg p-1 text-sm">
                            <button data-size="small" class="font-size-btn w-full rounded-md py-1 px-3 transition-colors">小</button>
                            <button data-size="medium" class="font-size-btn w-full rounded-md py-1 px-3 transition-colors">中</button>
                            <button data-size="large" class="font-size-btn w-full rounded-md py-1 px-3 transition-colors">大</button>
                        </div>
                    </div>
                    <div class="p-4 rounded-lg bg-card">
                        <label for="font-url-input" class="block text-sm font-medium mb-2">字体文件URL (支持.ttf, .otf, .woff等)</label>
                        <input type="text" id="font-url-input" class="form-input w-full" placeholder="https://example.com/font.ttf">
                        <button id="font-save-button" class="w-full mt-4 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-md">应用字体</button>
                        </div>
                </div>
            </div>

            <div id="api-settings-screen" class="app-screen-view api-settings-screen flex-col hidden">
                <div class="app-header">
                    <button id="api-settings-back-button" class="app-header-btn"><i class="fas fa-chevron-left"></i></button>
                    <h3 class="app-header-title flex-grow text-center">API 设定</h3>
                </div>
                <div class="settings-content flex-1 p-2 overflow-y-auto space-y-6">
                     <div class="p-4 rounded-lg bg-card">
                        <h3 class="font-bold mb-4">连接设定</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="api_url" class="block text-sm font-medium mb-1">API 地址:</label>
                                <!-- MODIFICATION START: Updated placeholder -->
                                <input type="text" id="api_url" placeholder="例如: https://api.example.com/v1" class="api-input form-input">
                                <!-- MODIFICATION END -->
                            </div>
                            <div>
                                <label for="api_key" class="block text-sm font-medium mb-1">API 密钥:</label>
                                <input type="password" id="api_key" placeholder="在此输入您的API金钥" class="api-input form-input">
                            </div>
                        </div>
                    </div>

                    <div class="p-4 rounded-lg bg-card">
                        <h3 class="font-bold mb-4">模型选择</h3>
                        <div class="space-y-4">
                             <div>
                                <label for="model_select" class="block text-sm font-medium mb-1">选取 API 模型:</label>
                                <div class="flex items-center gap-2">
                                    <select id="model_select" class="api-input form-select flex-grow">
                                        <!-- Models will be populated by JS -->
                                    </select>
                                    <button id="fetch_models_btn" class="px-3 py-2 bg-gray-600 text-white rounded-md text-sm flex-shrink-0">获取模型</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button id="save_settings_btn" class="w-full flex justify-center items-center mt-2 px-4 py-3 border border-transparent text-base font-medium rounded-md text-white bg-gray-700 hover:bg-gray-600">保存设定</button>
                    <div id="api-status" class="mt-4 p-4 rounded-lg text-center font-semibold text-sm hidden"></div>
                    <div id="security-warning" class="bg-yellow-100 text-yellow-700 mt-4 p-4 rounded-lg hidden" role="alert">
                        <p class="font-bold">安全提醒</p>
                        <p>API 金钥储存在浏览器本地储存中，这在公共电脑上可能不安全。请谨慎使用。</p>
                    </div>
                </div>
            </div>

            <div id="voice-call-screen" class="call-screen">
                <div class="call-background" id="voice-call-bg"></div>
                <div class="call-content">
                    <div class="flex flex-col items-center flex-shrink-0">
                        <img id="voice-call-avatar" src="https://placehold.co/300x300/777/FFF?text=?" alt="avatar">
                        <h3 id="voice-call-name" class="text-2xl font-bold mt-4">Character Name</h3>
                        <p id="voice-call-timer" class="text-gray-300">00:00</p>
                    </div>
                    <div class="mt-auto w-full">
                        <div class="call-status-box" id="voice-call-status-box"></div>
                        <div class="call-input-area">
                            <textarea id="voice-call-input" placeholder="输入互动文字..." rows="1"></textarea>
                            <button id="voice-call-send-btn"><i class="ri-send-plane-2-fill"></i></button>
                        </div>
                        <div class="call-controls">
                            <button id="voice-call-hangup" class="call-control-btn hangup-btn"><i class="ri-phone-fill rotate-135"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="video-call-screen" class="call-screen">
                <div class="call-background" id="video-call-bg"></div>
                <div class="call-content">
                    <div id="user-video-preview">
                        <img id="user-video-image" src="https://placehold.co/180x240/333/FFF?text=Me" alt="user video">
                    </div>
                    <div class="mt-auto w-full">
                        <div class="call-status-box" id="video-call-status-box"></div>
                         <div class="call-input-area">
                            <textarea id="video-call-input" placeholder="输入互动文字..." rows="1"></textarea>
                            <button id="video-call-send-btn"><i class="ri-send-plane-2-fill"></i></button>
                        </div>
                        <div class="call-controls">
                            <button id="video-call-hangup" class="call-control-btn hangup-btn"><i class="ri-phone-fill rotate-135"></i></button>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <script>
        // 全局變數
        let songList = [];
        let worldBooks = [];
        let characters = [];
        let chatHistories = {};
        let userAvatars = {};
        let chatBackgrounds = {};
        let chatBubbleColors = {};
        let userVideoImages = {};
        let myVideoImages = {};
        let currentChatCharacterId = null;

        const currentAudio = new Audio();
        let currentSongIndex = -1;
        let isLooping = false;
        let isSingleLooping = false;
        let currentEditingWorldBookId = null;
        let currentEditingCharacterId = null;
        
        let isMultiSelectMode = false;
        let selectedMessages = new Set();
        let activeMenu = null;

        let currentCallType = null;
        let callTimerInterval = null;


        // DOM 元素獲取
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const body = document.body;
        const messageBox = $('#messageBox');
        const currentTimeEl = $('#currentTime');
        const phoneScreen = $('#phone-screen');
        const homeWallpaper = $('#home-wallpaper');
        const statusBar = $('#status-bar');


        // 頁面切換
        const allScreens = $$('.app-screen-view');
        function showScreen(screenId) {
            allScreens.forEach(screen => {
                screen.classList.toggle('hidden', screen.id !== screenId);
                const isFlex = !['home-screen'].includes(screen.id);
                screen.classList.toggle('flex', screen.id === screenId && isFlex);
                if (!isFlex) screen.classList.remove('flex');
            });
            homeWallpaper.classList.toggle('hidden', screenId !== 'home-screen');
            statusBar.classList.toggle('on-home', screenId === 'home-screen');
            
            if (screenId === 'wechat-chat-screen') {
                const chatScreen = $('#wechat-chat-screen');
                const savedBg = chatBackgrounds[currentChatCharacterId];
                if (savedBg) {
                    chatScreen.querySelector('.chat-background').style.backgroundImage = `url(${savedBg})`;
                    chatScreen.classList.add('has-custom-bg');
                    statusBar.classList.add('transparent-override');
                } else {
                    chatScreen.querySelector('.chat-background').style.backgroundImage = '';
                    chatScreen.classList.remove('has-custom-bg');
                    statusBar.classList.remove('transparent-override');
                }
            } else {
                statusBar.classList.remove('transparent-override');
            }
        }

        // 數據保存與加載
        function saveData(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error("保存数据失败:", e);
                showMessageBox('存储空间已满，无法保存。');
            }
        }

        function loadData(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (e) {
                console.error("加载数据失败:", e);
                return defaultValue;
            }
        }

        async function loadAllSavedData() {
            const savedTheme = loadData('theme', 'dark');
            body.className = `flex items-center justify-center min-h-screen ${savedTheme}-mode`;
            $('#theme-icon').className = `fas fa-${savedTheme === 'dark' ? 'moon' : 'sun'} text-lg`;

            const savedWallpaper = loadData('saved_wallpaper');
            if(savedWallpaper) homeWallpaper.style.backgroundImage = `url(${savedWallpaper})`;

            const savedBg = loadData('saved_music_background');
            if (savedBg) $('#music-block').style.backgroundImage = `url(${savedBg})`;
            
            const savedVinyl = loadData('saved_vinyl_cover');
            if (savedVinyl) $('#vinyl-record').style.backgroundImage = `url(${savedVinyl})`;

            const savedPhoto = loadData('saved_photo_widget');
            if (savedPhoto) {
                $('#photo-widget').style.backgroundImage = `url(${savedPhoto})`;
                $('#photo-widget-text').style.opacity = 0;
            }

            const savedWidgetImg = loadData('saved_widget_image');
            if (savedWidgetImg) {
                const placeholder = $('#widget-image-placeholder');
                placeholder.style.backgroundImage = `url(${savedWidgetImg})`;
                const icon = placeholder.querySelector('i');
                if (icon) icon.style.display = 'none';
            }
            
            $$('.app-icon').forEach(iconEl => {
                const appName = iconEl.dataset.appName;
                const savedIcon = loadData(`saved_icon_${appName}`);
                if (savedIcon) {
                    iconEl.style.backgroundImage = `url(${savedIcon})`;
                    const i = iconEl.querySelector('i');
                    if(i) i.style.display = 'none';
                    iconEl.style.backgroundSize = 'contain';
                    iconEl.style.backgroundRepeat = 'no-repeat';
                }
            });

            $('#mood-text').value = loadData('saved_mood_text', '');
            $('#widget-name-input').value = loadData('saved_widget_name', '');
            $('#widget-thinking-input').value = loadData('saved_widget_thinking', '');
            $('#widget-location-input').value = loadData('saved_widget_location', '');

            worldBooks = loadData('worldBooks', []);
            characters = loadData('characters', []);
            
            chatHistories = loadData('chatHistories', {});
            Object.keys(chatHistories).forEach(key => {
                if(Array.isArray(chatHistories[key])) {
                    chatHistories[key] = { history: chatHistories[key], pinned: false };
                }
            });
            userAvatars = loadData('userAvatars', {});
            chatBackgrounds = loadData('chatBackgrounds', {});
            chatBubbleColors = loadData('chatBubbleColors', {});
            userVideoImages = loadData('userVideoImages', {});
            myVideoImages = loadData('myVideoImages', {});
            
            songList = loadData('songList', []);
            updateSongListUI();
            
            const savedFontUrl = loadData('saved_font_url');
            if(savedFontUrl) {
                $('#font-url-input').value = savedFontUrl;
                applyFont(savedFontUrl);
            }

            const savedFontSize = loadData('fontSize', 'medium');
            setFontSize(savedFontSize);

            const savedApiSettings = loadData('api_settings');
            if (savedApiSettings && savedApiSettings.url && savedApiSettings.key) {
                $('#api_url').value = savedApiSettings.url;
                $('#api_key').value = savedApiSettings.key;
                
                const modelSelect = $('#model_select');
                if (savedApiSettings.model && !Array.from(modelSelect.options).some(opt => opt.value === savedApiSettings.model)) {
                    const option = document.createElement('option');
                    option.value = savedApiSettings.model;
                    option.textContent = savedApiSettings.model.startsWith('models/') ? savedApiSettings.model.substring(7) : savedApiSettings.model;
                    modelSelect.appendChild(option);
                }
                modelSelect.value = savedApiSettings.model;
                
                const isValid = await fetchModels(true);
                updateApiStatusUI(isValid);
            } else {
                updateApiStatusUI(false);
            }
        }

        // 通用功能
        function showMessageBox(message) {
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), 2000);
        }

        function updateTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            currentTimeEl.textContent = `${hours}:${minutes}`;
        }

        function updateApiStatusUI(isOnline) {
            const statusText = $('#api-status-text');
            statusText.classList.remove('api-status-on', 'text-red-500');
            if (isOnline) {
                statusText.textContent = 'API ON';
                statusText.classList.add('api-status-on');
            } else {
                statusText.textContent = 'API OFF';
                statusText.classList.add('text-red-500');
            }
        }
        
        // MODIFICATION START: Corrected fetchModels function
        async function fetchModels(isSilent = false) {
            const apiUrl = $('#api_url').value.trim();
            const apiKey = $('#api_key').value.trim();
            const modelSelect = $('#model_select');

            if (!apiUrl || !apiKey) {
                if (!isSilent) showMessageBox("请输入 API 地址和密钥");
                updateApiStatusUI(false);
                return false;
            }

            if (!isSilent) showMessageBox("正在获取模型列表...");
            
            // Correctly constructs the URL as per user's request: user_input + /models
            const finalUrl = apiUrl.replace(/\/+$/, '') + '/models';

            try {
                const response = await fetch(finalUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`连接失败: HTTP ${response.status}`);
                }

                const data = await response.json();
                const models = data.data || data.models || [];

                if (models.length > 0) {
                    const currentSelectedModel = modelSelect.value;
                    modelSelect.innerHTML = '';
                    models.forEach(model => {
                        const modelId = model.id || model.name;
                        if (modelId) {
                            const option = document.createElement('option');
                            option.value = modelId;
                            option.textContent = modelId.startsWith('models/') ? modelId.substring(7) : modelId;
                            modelSelect.appendChild(option);
                        }
                    });
                    
                    if (Array.from(modelSelect.options).some(opt => opt.value === currentSelectedModel)) {
                        modelSelect.value = currentSelectedModel;
                    }

                    if (!isSilent) showMessageBox("成功获取模型列表！");
                    updateApiStatusUI(true);
                    return true;
                } else {
                    throw new Error("API返回了空模型列表");
                }
            } catch (error) {
                console.error("获取模型失败:", error);
                if (!isSilent) showMessageBox(`获取模型失败: ${error.message}`);
                updateApiStatusUI(false);
                return false;
            }
        }
        // MODIFICATION END

        function hexToRgba(hex, alpha = 1) {
            if (!/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)) {
                return null;
            }
            let c = hex.substring(1).split('');
            if (c.length === 3) {
                c = [c[0], c[0], c[1], c[1], c[2], c[2]];
            }
            c = '0x' + c.join('');
            return `rgba(${[(c>>16)&255, (c>>8)&255, c&255].join(',')},${alpha})`;
        }


        // 頁面與組件邏輯
        function toggleTheme() {
            body.classList.toggle('dark-mode');
            body.classList.toggle('light-mode');
            const theme = body.classList.contains('dark-mode') ? 'dark' : 'light';
            $('#theme-icon').className = `fas fa-${theme === 'dark' ? 'moon' : 'sun'} text-lg`;
            saveData('theme', theme);
        }
        
        function compressImage(file, options = {}) {
            return new Promise((resolve, reject) => {
                const { maxWidth = 800, maxHeight = 800, quality = 0.7 } = options;
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let { width, height } = img;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
        }
        
        async function handleImageUpload(inputElement, displayElement, storageKey, options = {}) {
            const file = inputElement.files[0];
            if (!file) return;

            try {
                const compressedDataUrl = await compressImage(file, options.compression);
                if (displayElement) {
                    displayElement.style.backgroundImage = `url(${compressedDataUrl})`;
                    displayElement.style.backgroundSize = 'cover';
                    displayElement.style.backgroundPosition = 'center';
                }
                
                if (storageKey) {
                    saveData(storageKey, compressedDataUrl);
                }

                if (options.hideTextElement) $(options.hideTextElement).style.opacity = 0;

                if(displayElement) {
                    const icon = displayElement.querySelector('i');
                    if (icon) icon.style.display = 'none';
                }
                
                return compressedDataUrl;

            } catch (error) {
                console.error("图片压缩失败:", error);
                showMessageBox("图片处理失败，请重试。");
                return null;
            }
        }
        
        // 聊天逻辑
        const chatContentArea = $('#wechat-content-chat');
        function renderChatHistory() {
            chatContentArea.innerHTML = '';
            const chatSession = chatHistories[currentChatCharacterId];
            if (!chatSession) return;

            const history = chatSession.history || [];
            if (history.length === 0 && currentChatCharacterId) {
                chatContentArea.innerHTML = `<p class="text-center text-gray-500 text-xs py-4">你已和 ${characters.find(c => c.id === currentChatCharacterId)?.name || '未知角色'} 建立对话，开始聊天吧！</p>`;
            }
            
            let lastSender = null;
            history.forEach((msg, index) => {
                const isNewSender = index === 0 || history[index - 1].sender !== msg.sender;
                appendMessage(msg.content, msg.sender, msg.type, false, msg.timestamp, isNewSender);
            });
            chatContentArea.scrollTop = chatContentArea.scrollHeight;
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        function appendMessage(content, sender, type = 'text', shouldSave = true, timestamp = Date.now(), isNewSender = false) {
            const senderClass = sender === 'user' ? 'sent' : 'received';

            const messageWrapper = document.createElement('div');
            messageWrapper.className = `chat-message-wrapper ${senderClass}`;
            messageWrapper.dataset.timestamp = timestamp;
            messageWrapper.dataset.sender = sender;
            
            if (isNewSender) {
                messageWrapper.classList.add('new-sender');
            }

            const character = characters.find(c => c.id === currentChatCharacterId);
            
            const avatar = document.createElement('div');
            avatar.className = 'chat-avatar';
            if (isNewSender) {
                if (sender === 'ai') {
                    if (character?.avatar) {
                        avatar.style.backgroundImage = `url(${character.avatar})`;
                    } else {
                        avatar.innerHTML = '<i class="fas fa-robot"></i>';
                    }
                } else {
                    avatar.classList.add('user-avatar-in-chat');
                    const userAvatarForThisChat = userAvatars[currentChatCharacterId];
                    if (userAvatarForThisChat) {
                        avatar.style.backgroundImage = `url(${userAvatarForThisChat})`;
                    } else {
                        avatar.innerHTML = '<i class="fas fa-user"></i>';
                    }
                }
            } else {
                avatar.style.visibility = 'hidden';
            }

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'chat-message-content';

            const messageBubble = document.createElement('div');
            
            if (type === 'image') {
                messageBubble.className = `chat-message ${senderClass} image-message`;
                const img = document.createElement('img');
                img.src = content;
                messageBubble.appendChild(img);
            } else if (type === 'voice') {
                messageBubble.className = `chat-message ${senderClass} voice-message`;
                const duration = Math.max(1, Math.round(content.length / 4));
                const iconClass = sender === 'user' ? 'ri-play-fill' : 'ri-play-line';
                messageBubble.innerHTML = `
                    <div class="voice-main">
                        <i class="${iconClass} voice-play-icon"></i>
                        <span class="voice-duration">${duration}"</span>
                    </div>
                    <p class="voice-text">${content}</p>
                `;
                messageBubble.addEventListener('click', () => {
                    const voiceText = messageBubble.querySelector('.voice-text');
                    voiceText.style.display = voiceText.style.display === 'block' ? 'none' : 'block';
                });
            } else if (type === 'system') {
                messageBubble.className = 'chat-system-message';
                messageBubble.innerHTML = `<p>${content}</p>`;
                messageWrapper.className = 'chat-message-wrapper justify-center';
                avatar.style.display = 'none';
            }
            else {
                messageBubble.className = `chat-message ${senderClass}`;
                const formattedMessage = content.replace(/(\*|_)(.*?)\1/g, '<i>$2</i>');
                messageBubble.innerHTML = `<p>${formattedMessage}</p>`;
            }

            if (type !== 'system') {
                const customColors = chatBubbleColors[currentChatCharacterId];
                const isDarkMode = body.classList.contains('dark-mode');
                let bubbleColor;
                if (customColors) {
                    const colorHex = sender === 'user' ? customColors.user : customColors.ai;
                    if (colorHex) {
                        const colorRgba = hexToRgba(colorHex, isDarkMode ? 0.6 : 0.7);
                        if (colorRgba) {
                            bubbleColor = colorRgba;
                            messageBubble.style.backgroundColor = bubbleColor;
                        }
                    }
                }
                const defaultBg = isDarkMode ? (sender === 'user' ? 'rgba(219, 39, 119, 0.5)' : 'rgba(74, 74, 74, 0.5)') : (sender === 'user' ? 'rgba(249, 168, 212, 0.6)' : 'rgba(229, 231, 250, 0.8)');
                messageBubble.style.setProperty('--bubble-bg', bubbleColor || defaultBg);
            }

            contentWrapper.appendChild(messageBubble);

            const metaDiv = document.createElement('div');
            metaDiv.className = 'message-meta';
            const timeSpan = document.createElement('span');
            timeSpan.className = 'message-timestamp';
            timeSpan.textContent = formatTimestamp(timestamp);
            metaDiv.appendChild(timeSpan);

            if (sender === 'user') {
                const readSpan = document.createElement('span');
                readSpan.className = 'message-read-status';
                readSpan.textContent = '已读';
                readSpan.id = `read-status-${timestamp}`;
                metaDiv.appendChild(readSpan);
            }

            if (type === 'system') {
                messageWrapper.appendChild(contentWrapper);
            } else if (senderClass === 'received') {
                messageWrapper.appendChild(avatar);
                messageWrapper.appendChild(contentWrapper);
                messageWrapper.appendChild(metaDiv);
            } else {
                messageWrapper.appendChild(metaDiv);
                messageWrapper.appendChild(contentWrapper);
                messageWrapper.appendChild(avatar);
            }
            
            const placeholder = chatContentArea.querySelector('p.text-center');
            if (placeholder) placeholder.remove();

            chatContentArea.appendChild(messageWrapper);
            if(shouldSave) chatContentArea.scrollTop = chatContentArea.scrollHeight;

            if (shouldSave && currentChatCharacterId) {
                if (!chatHistories[currentChatCharacterId]) {
                    chatHistories[currentChatCharacterId] = { history: [], pinned: false };
                }
                chatHistories[currentChatCharacterId].history.push({ content, sender, type, timestamp });
                saveData('chatHistories', chatHistories);
            }
        }

        // MODIFICATION START: Corrected getAIResponse function
        async function getAIResponse(lastUserMessage, isRetry = false) {
            const apiSettings = loadData('api_settings');
            if (!apiSettings || !apiSettings.url || !apiSettings.key || !apiSettings.model) {
                return showMessageBox("请先在设置中配置 API");
            }

            const lastReadStatus = Array.from(chatContentArea.querySelectorAll('.message-read-status')).pop();
            if (lastReadStatus) lastReadStatus.classList.add('visible');

            let thinkingMessage;
            if (!isRetry) {
                appendMessage("...", 'ai', 'text', false, Date.now(), true);
                thinkingMessage = chatContentArea.lastElementChild;
            }

            try {
                const character = characters.find(c => c.id === currentChatCharacterId);
                const linkedBooks = worldBooks.filter(wb => character.linkedWorldBookIds.includes(wb.id));
                const worldBookContext = linkedBooks.map(wb => `[${wb.title}]\n${wb.content}`).join('\n\n');
                const chatHistory = (chatHistories[currentChatCharacterId]?.history || []);
                const historyForApi = chatHistory.filter(msg => msg.type === 'text' || msg.type === 'image').slice(-10);

                const systemPrompt = `
                    # 角色扮演指令
                    你将扮演我的soulmate，你的名字是${character.name}。这是一个手机软件，我们所有交流均以对白为主，非必要不描写其他。你的回复绝对不能包含任何引号，例如 " " 或 “ ”。
                    # 环境/动作/心理描写规则
                    一旦涉及到见面的环境，所有关于”环境、心理、动作“等外在因素、环境描写，都需要用第三人称”他“”她“，或者第二人称”他“，”你“，并在文字当中用斜体，例如 *他俯下身亲吻了你*。在描写中禁止用第一人称，比如”我亲吻了你“，这是被禁止的。正确示范应该是：”*他俯下身亲吻了她*“或”*他俯下身亲吻了你*“。在日记和动态等其他心理活动板块中可以提到“我”，例如，“今天我见到她了，好想她”，但这仅限于日记等记录的板块。
                    # 新增指令：发送语音
                    当你想要表达亲密、惊讶或有趣的语气时，可以将回复包装成语音格式，例如：[VOICE:你好呀！今天过得怎么样？]。程序会自动将其渲染为语音条。
                    # 新增指令：发起通话
                    在剧情和情感推动下，你可以主动发起通话。指令格式为 [CALL:VOICE] 或 [CALL:VIDEO]。这会向用户弹出通话邀请。
                    # 你的角色设定: ${character.persona}
                    # 我（用户）的角色设定: ${character.myPersona}
                    # 我们的世界观背景: ${worldBookContext}
                    # 对话格式指令 (非常重要!)
                    - 你的回复必须模仿真实的人类聊天习惯。将你的想法拆分成多个简短的句子，并用 "|||" 作为分隔符。每一段由 "|||" 分隔的内容都会成为一个独立的气泡。
                    - 任何第三人称的*动作或环境描写* (例如 *他笑了*) 都必须是独立的一段，用 "|||" 与其他对话分开。
                    - 严禁在回复的开头说“好的”或任何确认收到指令的话。你必须直接以 ${character.name} 的身份开始对话。
                    - 示例: "早安|||*他伸了个懒腰*|||你醒啦？" 这将会被显示为三个独立的气泡。
                `;

                const isGoogleApi = apiSettings.url.includes('googleapis.com');
                let finalApiUrl;
                let requestBody;
                let headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiSettings.key}`
                };
                
                if (isGoogleApi) {
                    finalApiUrl = `${apiSettings.url.replace(/\/+$/, '')}/${apiSettings.model}:generateContent?key=${apiSettings.key}`;
                    headers = { 'Content-Type': 'application/json' };

                    const contents = historyForApi.map(msg => ({
                        role: msg.sender === 'user' ? 'user' : 'model',
                        parts: msg.type === 'image' 
                            ? [{ text: "我发了一张图片，请你根据图片内容进行回应。" }, { inlineData: { mimeType: "image/jpeg", data: msg.content.split(',')[1] } }]
                            : [{ text: msg.content }]
                    }));
                    
                    requestBody = JSON.stringify({ contents, systemInstruction: { parts: [{ text: systemPrompt }] } });
                } else { // OpenAI-Compatible
                    finalApiUrl = `${apiSettings.url.replace(/\/+$/, '')}/chat/completions`;

                    const messages = [{ role: "system", content: systemPrompt }];
                    historyForApi.forEach(msg => {
                        const role = msg.sender === 'user' ? 'user' : 'assistant';
                        if (msg.type === 'image') {
                            messages.push({ role: 'user', content: [
                                { type: 'text', text: '我发了一张图片，请你根据图片内容进行回应。' },
                                { type: 'image_url', image_url: { url: msg.content } }
                            ]});
                        } else {
                            messages.push({ role: role, content: msg.content });
                        }
                    });

                    requestBody = JSON.stringify({
                        model: apiSettings.model,
                        messages: messages,
                    });
                }

                const response = await fetch(finalApiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: requestBody
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("API Error Response:", errorText);
                    const errorData = JSON.parse(errorText || "{}");
                    throw new Error(errorData.error?.message || `HTTP 错误 ${response.status}`);
                }

                const result = await response.json();
                let aiMessage;

                if (isGoogleApi) {
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts) {
                        aiMessage = result.candidates[0].content.parts[0].text;
                    } else {
                        const blockReason = result.promptFeedback?.blockReason || '无内容返回';
                        throw new Error(`响应被安全策略拦截: ${blockReason}`);
                    }
                } else { // OpenAI-Compatible
                    aiMessage = result.choices[0].message.content;
                }

                if (thinkingMessage) thinkingMessage.remove();
                
                const callMatch = aiMessage.match(/\[CALL:(VOICE|VIDEO)\]/);
                if (callMatch) {
                    const callType = callMatch[1].toLowerCase();
                    triggerIncomingCall(callType);
                    const remainingMessage = aiMessage.replace(callMatch[0], '').trim();
                    if (remainingMessage) {
                         processAndDisplayAIMessages(remainingMessage);
                    }
                } else {
                    processAndDisplayAIMessages(aiMessage);
                }

            } catch (error) {
                console.error("AI 响应错误:", error);
                if (thinkingMessage) {
                    const bubble = thinkingMessage.querySelector('.chat-message p');
                    if (bubble) bubble.textContent = `AI 响应失败: ${error.message}`;
                }
            }
        }
        // MODIFICATION END
        
        function processAndDisplayAIMessages(messageText) {
            const messageParts = messageText.split('|||').map(p => p.trim()).filter(p => p);
            messageParts.forEach((part, index) => {
                setTimeout(() => {
                    const isNew = index === 0;
                    if (part.startsWith('[VOICE:') && part.endsWith(']')) {
                        const voiceText = part.substring(7, part.length - 1);
                        appendMessage(voiceText, 'ai', 'voice', true, Date.now(), isNew);
                    } else {
                        appendMessage(part, 'ai', 'text', true, Date.now(), isNew);
                    }
                }, index * 500);
            });
        }

        async function handleSendMessage() {
            if (!currentChatCharacterId) return showMessageBox("请先选择聊天对象");
            
            const userMessage = $('#chat-input').value.trim();
            if (userMessage) {
                const history = chatHistories[currentChatCharacterId]?.history || [];
                const isNewSender = history.length === 0 || history[history.length - 1].sender !== 'user';
                const timestamp = Date.now();
                appendMessage(userMessage, 'user', 'text', true, timestamp, isNewSender);
                $('#chat-input').value = '';
                adjustTextareaHeight();
                await getAIResponse({ content: userMessage, type: 'text' });
            }
        }
        
        async function handleReceiveMessage() {
            if (!currentChatCharacterId) return showMessageBox("请先选择聊天对象");

            const chatSession = chatHistories[currentChatCharacterId];
            
            if (!chatSession || chatSession.history.length === 0) {
                const initialPrompt = { content: '[用户按下了接收键，请你作为角色主动开启一段对话。]', type: 'text' };
                await getAIResponse(initialPrompt);
                return; 
            }

            const lastMessage = chatSession.history[chatSession.history.length - 1];
            if (lastMessage.sender === 'ai') {
                return showMessageBox("AI刚刚回复过，该你啦");
            }
            
            if (lastMessage.sender === 'user') {
                await getAIResponse(lastMessage);
            }
        }
        
        function startChatWithCharacter(characterId) {
            currentChatCharacterId = characterId;
            const character = characters.find(c => c.id === characterId);
            if (character) {
                $('#wechat-contact-name').textContent = character.name;
                renderChatHistory();
                showScreen('wechat-chat-screen');
            }
        }

        function renderWeChatList() {
            const container = $('#wechat-list-container');
            container.innerHTML = '';
            const chatCharacterIds = Object.keys(chatHistories);

            if (chatCharacterIds.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-8">还没有聊天，点击右上角 + 开始吧</p>';
                return;
            }
            
            chatCharacterIds.sort((a, b) => {
                const aPinned = chatHistories[a]?.pinned;
                const bPinned = chatHistories[b]?.pinned;
                if (aPinned && !bPinned) return -1;
                if (!aPinned && bPinned) return 1;
                return 0;
            });

            chatCharacterIds.forEach(charId => {
                const character = characters.find(c => c.id === charId);
                if (!character) return;

                const chatSession = chatHistories[charId];
                const history = chatSession.history;
                const lastMessage = history[history.length - 1];
                
                let lastMessagePreview = '...';
                if(lastMessage) {
                    const prefix = lastMessage.sender === 'user' ? '我: ' : '';
                    if(lastMessage.type === 'image') {
                        lastMessagePreview = prefix + '[图片]';
                    } else if (lastMessage.type === 'voice') {
                        lastMessagePreview = prefix + '[语音]';
                    } else {
                        lastMessagePreview = prefix + lastMessage.content;
                    }
                }

                const item = document.createElement('div');
                item.className = 'wechat-list-item';
                if (chatSession.pinned) {
                    item.style.backgroundColor = body.classList.contains('dark-mode') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
                }
                const avatarStyle = character.avatar ? `background-image: url(${character.avatar})` : '';
                const avatarContent = character.avatar ? '' : '<i class="fas fa-user text-xl"></i>';

                item.innerHTML = `
                    <div class="w-12 h-12 rounded-full mr-4 bg-zinc-600 flex-shrink-0 flex items-center justify-center bg-cover bg-center" style="${avatarStyle}">${avatarContent}</div>
                    <div class="flex-grow overflow-hidden">
                        <h4 class="font-semibold text-base">${character.name}</h4>
                        <p class="text-sm text-gray-400 last-message">${lastMessagePreview}</p>
                    </div>
                `;
                item.addEventListener('click', () => startChatWithCharacter(charId));
                container.appendChild(item);
            });
        }

        function renderWorldBookList() {
            const container = $('#world-book-list-container');
            container.innerHTML = '';
            if (worldBooks.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-4">还没有世界书，点击右上角添加一本吧。</p>';
                return;
            }
            worldBooks.forEach(book => {
                const item = document.createElement('div');
                item.className = 'list-item deletable';
                item.innerHTML = `<h4 class="font-bold text-lg">${book.title}</h4>`;
                
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'list-item-delete-btn';
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    showDeleteConfirmation('worldBook', book.id, book.title);
                };
                item.prepend(deleteBtn);

                item.addEventListener('click', () => {
                    currentEditingWorldBookId = book.id;
                    $('#wb-title-input').value = book.title;
                    $('#wb-content-input').value = book.content;
                    showScreen('world-book-edit-screen');
                });
                container.appendChild(item);
            });
        }
        
        function renderCharacterBookList() {
            const container = $('#character-book-list-container');
            container.innerHTML = '';
            if (characters.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-4">还没有角色，点击右上角添加一个吧。</p>';
                return;
            }
            characters.forEach(char => {
                const item = document.createElement('div');
                item.className = 'list-item'; 
                const avatarStyle = char.avatar ? `background-image: url(${char.avatar})` : '';
                const avatarContent = char.avatar ? '' : '<i class="fas fa-user text-xl"></i>';
                
                item.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-12 h-12 rounded-full mr-4 bg-zinc-600 flex-shrink-0 flex items-center justify-center bg-cover bg-center" style="${avatarStyle}">${avatarContent}</div>
                        <h4 class="font-bold text-lg">${char.name}</h4>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    currentEditingCharacterId = char.id;
                    showCharacterEditScreen(char);
                });
                container.appendChild(item);
            });
        }
        
        function showCharacterEditScreen(character = null) {
            const avatarPlaceholder = $('#character-avatar-placeholder');
            const avatarIcon = avatarPlaceholder.querySelector('i');
            const deleteBtn = $('#cb-delete-button');

            if (character) {
                currentEditingCharacterId = character.id;
                if (character.avatar) {
                    avatarPlaceholder.style.backgroundImage = `url(${character.avatar})`;
                    if (avatarIcon) avatarIcon.style.display = 'none';
                } else {
                    avatarPlaceholder.style.backgroundImage = '';
                    if (avatarIcon) avatarIcon.style.display = 'flex';
                }
                $('#cb-name-input').value = character.name;
                $('#cb-persona-input').value = character.persona;
                $('#cb-my-persona-input').value = character.myPersona;
                deleteBtn.classList.remove('hidden');
            } else {
                currentEditingCharacterId = null;
                avatarPlaceholder.style.backgroundImage = '';
                if (avatarIcon) avatarIcon.style.display = 'flex';
                $('#cb-name-input').value = '';
                $('#cb-persona-input').value = '';
                $('#cb-my-persona-input').value = '';
                deleteBtn.classList.add('hidden');
            }
            
            const selectEl = $('#cb-worldbook-select');
            selectEl.innerHTML = worldBooks.length ? '' : '<p class="text-gray-400 text-sm">请先去世界书创建世界观</p>';
            
            worldBooks.forEach(book => {
                const isChecked = character?.linkedWorldBookIds?.includes(book.id);
                const checkboxItem = document.createElement('label');
                checkboxItem.className = 'wb-checkbox-label';
                checkboxItem.innerHTML = `<input type="checkbox" value="${book.id}" ${isChecked ? 'checked' : ''}><span>${book.title}</span>`;
                selectEl.appendChild(checkboxItem);
            });
            
            showScreen('character-book-edit-screen');
        }

        async function saveCharacter() {
            const name = $('#cb-name-input').value.trim();
            if (!name) return showMessageBox('角色姓名不能为空');

            const avatarInput = $('#character-avatar-input');
            let avatarDataUrl = null;
            if (avatarInput.files[0]) {
                 avatarDataUrl = await handleImageUpload(avatarInput, $('#character-avatar-placeholder'), null, { compression: { maxWidth: 256, maxHeight: 256 } });
            }

            const selectedWBIds = Array.from($$('#cb-worldbook-select input:checked')).map(input => input.value);
            
            if (currentEditingCharacterId) {
                const charIndex = characters.findIndex(c => c.id === currentEditingCharacterId);
                if (charIndex > -1) {
                    const existingChar = characters[charIndex];
                    existingChar.name = name;
                    existingChar.persona = $('#cb-persona-input').value.trim();
                    existingChar.myPersona = $('#cb-my-persona-input').value.trim();
                    existingChar.linkedWorldBookIds = selectedWBIds;
                    if (avatarDataUrl) {
                        existingChar.avatar = avatarDataUrl;
                    }
                }
            } else {
                const newCharacter = {
                    id: `char_${Date.now()}`,
                    name: name,
                    avatar: avatarDataUrl || null,
                    persona: $('#cb-persona-input').value.trim(),
                    myPersona: $('#cb-my-persona-input').value.trim(),
                    linkedWorldBookIds: selectedWBIds,
                };
                characters.push(newCharacter);
            }
            
            saveData('characters', characters);
            renderCharacterBookList();
            showMessageBox('角色已保存');
            showScreen('character-book-list-screen');
        }

        // 音樂播放器
        function startSpinning() { $('#vinyl-container').classList.add('record-spin'); }
        function stopSpinning() { $('#vinyl-container').classList.remove('record-spin'); }
        
        function updateSongListUI() {
            const container = $('#song-list-container');
            container.innerHTML = '';
            if (songList.length === 0) {
                container.innerHTML = '<li class="p-3 text-center text-gray-400">请点击右下角音乐图标上传歌曲</li>';
                return;
            }
            songList.forEach((song, index) => {
                const li = document.createElement('li');
                li.className = `song-list-item text-white ${index === currentSongIndex ? 'active' : ''}`;
                li.dataset.index = index;
                li.draggable = true;
                li.innerHTML = `
                    <div class="song-list-item-left">
                        <span class="drag-handle"><i class="fas fa-grip-lines"></i></span>
                        <span class="song-list-item-name">${song.name}</span>
                    </div>
                    <button class="delete-button text-gray-400 p-2"><i class="fas fa-trash-alt"></i></button>
                `;
                li.querySelector('.song-list-item-name').addEventListener('click', () => playSong(index));
                li.querySelector('.delete-button').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const item = e.currentTarget.closest('.song-list-item');
                    if (item.classList.contains('pending-delete')) {
                        deleteSong(parseInt(item.dataset.index));
                    } else {
                        $$('.song-list-item.pending-delete').forEach(el => el.classList.remove('pending-delete'));
                        item.classList.add('pending-delete');
                        showMessageBox('再次点击以确认删除');
                    }
                });
                li.addEventListener('dragstart', handleDragStart);
                li.addEventListener('dragover', handleDragOver);
                li.addEventListener('dragleave', handleDragLeave);
                li.addEventListener('drop', handleDrop);
                li.addEventListener('dragend', handleDragEnd);
                container.appendChild(li);
            });
        }
        
        function deleteSong(index) {
            if (index === currentSongIndex) {
                currentAudio.pause();
                stopSpinning();
                currentSongIndex = -1;
            }
            songList.splice(index, 1);
            if (index < currentSongIndex) currentSongIndex--;
            saveData('songList', songList.map(s => ({name: s.name})));
            showMessageBox('歌曲已删除');
            updateSongListUI();
            if (currentSongIndex === -1 && songList.length > 0) playSong(0);
        }

        let draggedItem = null;
        function handleDragStart(e){ draggedItem = this; this.style.opacity = '0.4'; }
        function handleDragOver(e){ e.preventDefault(); }
        function handleDragLeave(e){}
        function handleDrop(e){
            const dropIndex = parseInt(this.dataset.index);
            const dragIndex = parseInt(draggedItem.dataset.index);
            const [draggedSong] = songList.splice(dragIndex, 1);
            songList.splice(dropIndex, 0, draggedSong);
            if (dragIndex === currentSongIndex) currentSongIndex = dropIndex;
            else if (dragIndex < currentSongIndex && dropIndex >= currentSongIndex) currentSongIndex--;
            else if (dragIndex > currentSongIndex && dropIndex <= currentSongIndex) currentSongIndex++;
            saveData('songList', songList.map(s => ({name: s.name})));
            updateSongListUI();
        }
        function handleDragEnd(e){ this.style.opacity = '1'; }

        function playSong(index) {
            if (index < 0 || index >= songList.length || !songList[index].url) {
                showMessageBox("无法播放此歌曲，请重新上传。");
                return;
            };
            currentAudio.pause();
            currentSongIndex = index;
            const newSong = songList[currentSongIndex];
            currentAudio.src = newSong.url;
            currentAudio.play().then(() => {
                startSpinning();
                $('#play-pause-button i').className = 'fas fa-pause text-xl';
                showMessageBox(`正在播放：${newSong.name}`);
            }).catch(e => showMessageBox('无法播放此音乐文件'));
            currentAudio.onended = () => {
                if (isSingleLooping) playSong(currentSongIndex);
                else if (isLooping) playSong((currentSongIndex + 1) % songList.length);
                else {
                    stopSpinning();
                    $('#play-pause-button i').className = 'fas fa-play text-xl';
                }
            };
            updateSongListUI();
        }

        // 字体设置
        function applyFont(url) {
            const styleId = 'custom-font-style';
            let styleElement = document.getElementById(styleId);
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = styleId;
                document.head.appendChild(styleElement);
            }
            styleElement.innerHTML = `
                @font-face {
                    font-family: 'CustomFont';
                    src: url('${url}');
                }
            `;
            phoneScreen.style.fontFamily = 'CustomFont, "PingFang SC", "Inter", sans-serif';
        }

        function setFontSize(size) {
            phoneScreen.classList.remove('text-size-small', 'text-size-large');
            if (size !== 'medium') {
                phoneScreen.classList.add(`text-size-${size}`);
            }
            $$('#font-size-selector .font-size-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.size === size);
            });
        }
        
        // 删除确认
        let deleteCallback = null;
        function showDeleteConfirmation(type, id, name) {
            const modal = $('#confirm-delete-modal');
            $('#delete-modal-title').textContent = `删除 "${name}"?`;
            
            let text = '此操作无法撤销。';
            if (type === 'character') {
                text += '所有相关的聊天记录也将被删除。';
            } else if (type === 'message') {
                 $('#delete-modal-title').textContent = `删除这条消息吗?`;
            } else if (type === 'multi-message') {
                $('#delete-modal-title').textContent = `删除 ${selectedMessages.size} 条消息吗?`;
            }
            $('#delete-modal-text').textContent = text;
            
            deleteCallback = () => {
                if (type === 'worldBook') {
                    worldBooks = worldBooks.filter(b => b.id !== id);
                    saveData('worldBooks', worldBooks);
                    renderWorldBookList();
                } else if (type === 'character') {
                    characters = characters.filter(c => c.id !== id);
                    delete chatHistories[id];
                    saveData('characters', characters);
                    saveData('chatHistories', chatHistories);
                    renderCharacterBookList();
                    showScreen('character-book-list-screen');
                } else if (type === 'chat') {
                    delete chatHistories[id];
                    saveData('chatHistories', chatHistories);
                    renderWeChatList();
                    showScreen('wechat-list-screen');
                } else if (type === 'message') {
                    const history = chatHistories[currentChatCharacterId].history;
                    const msgIndex = history.findIndex(m => String(m.timestamp) === String(id));
                    if (msgIndex > -1) {
                        history.splice(msgIndex, 1);
                        saveData('chatHistories', chatHistories);
                        renderChatHistory();
                    }
                } else if (type === 'multi-message') {
                    let history = chatHistories[currentChatCharacterId].history;
                    history = history.filter(m => !selectedMessages.has(String(m.timestamp)));
                    chatHistories[currentChatCharacterId].history = history;
                    saveData('chatHistories', chatHistories);
                    renderChatHistory();
                    exitMultiSelectMode();
                }
                if (type !== 'message' && type !== 'multi-message') {
                    showMessageBox(`"${name}" 已删除`);
                }
                modal.style.display = 'none';
                deleteCallback = null;
            };

            modal.style.display = 'flex';
        }

        // MODIFICATION START: Corrected getAICallResponse function
        async function getAICallResponse(callType) {
            const apiSettings = loadData('api_settings');
            if (!apiSettings || !apiSettings.url || !apiSettings.key || !apiSettings.model) {
                return showMessageBox("请先在设置中配置 API");
            }
            const statusBox = $(`#${callType}-call-status-box`);

            try {
                const character = characters.find(c => c.id === currentChatCharacterId);
                const linkedBooks = worldBooks.filter(wb => character.linkedWorldBookIds.includes(wb.id));
                const worldBookContext = linkedBooks.map(wb => `[${wb.title}]\n${wb.content}`).join('\n\n');
                
                const initialPrompt = `[我们现在开始${callType === 'voice' ? '语音' : '视频'}通话，请你主动开始对话，并用斜体描写一下当前的环境或你的动作。]`;

                const systemPrompt = `
                    # 角色扮演指令
                    你将扮演我的soulmate，你的名字是${character.name}。这是一个手机软件，我们所有交流均以对白为主，非必要不描写其他。你的回复绝对不能包含任何引号，例如 " " 或 “ ”。
                    # 环境/动作/心理描写规则
                    一旦涉及到见面的环境，所有关于”环境、心理、动作“等外在因素、环境描写，都需要用第三人称”他“”她“，或者第二人称”他“，”你“，并在文字当中用斜体，例如 *他俯下身亲吻了你*。在描写中禁止用第一人称，比如”我亲吻了你“，这是被禁止的。正确示范应该是：”*他俯下身亲吻了她*“或”*他俯下身亲吻了你*“。在日记和动态等其他心理活动板块中可以提到“我”，例如，“今天我见到她了，好想她”，但这仅限于日记等记录的板块。
                    # 你的角色设定: ${character.persona}
                    # 我（用户）的角色设定: ${character.myPersona}
                    # 我们的世界观背景: ${worldBookContext}
                `;

                const isGoogleApi = apiSettings.url.includes('googleapis.com');
                let finalApiUrl;
                let requestBody;
                let headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiSettings.key}`
                };

                if (isGoogleApi) {
                    finalApiUrl = `${apiSettings.url.replace(/\/+$/, '')}/${apiSettings.model}:generateContent?key=${apiSettings.key}`;
                    headers = { 'Content-Type': 'application/json' };
                    requestBody = JSON.stringify({
                        contents: [{ role: 'user', parts: [{ text: initialPrompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    });
                } else { // OpenAI-Compatible
                    finalApiUrl = `${apiSettings.url.replace(/\/+$/, '')}/chat/completions`;
                    requestBody = JSON.stringify({
                        model: apiSettings.model,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: initialPrompt }
                        ]
                    });
                }

                const response = await fetch(finalApiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: requestBody
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    const errorData = JSON.parse(errorText || "{}");
                    throw new Error(errorData.error?.message || `HTTP 错误 ${response.status}`);
                }

                const result = await response.json();
                let aiMessage;

                if (isGoogleApi) {
                    aiMessage = result.candidates[0].content.parts[0].text;
                } else {
                    aiMessage = result.choices[0].message.content;
                }

                if (statusBox) {
                    statusBox.innerHTML = ''; 
                    const p = document.createElement('p');
                    p.innerHTML = aiMessage.replace(/(\*|_)(.*?)\1/g, '<i>$2</i>');
                    statusBox.appendChild(p);
                }

            } catch (error) {
                console.error("AI 通话响应错误:", error);
                if (statusBox) {
                    statusBox.innerHTML = `<p>连接失败: ${error.message}</p>`;
                }
            }
        }
        // MODIFICATION END

        function startCallTimer(timerElement) {
            let seconds = 0;
            timerElement.textContent = '00:00';
            clearInterval(callTimerInterval);
            callTimerInterval = setInterval(() => {
                seconds++;
                const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
                const secs = String(seconds % 60).padStart(2, '0');
                timerElement.textContent = `${mins}:${secs}`;
            }, 1000);
        }

        function startVoiceCall() {
            const character = characters.find(c => c.id === currentChatCharacterId);
            if (!character) return;
            
            currentCallType = 'voice';
            const screen = $('#voice-call-screen');
            const avatarUrl = character.avatar || 'https://placehold.co/300x300/777/FFF?text=?';
            $('#voice-call-avatar').src = avatarUrl;
            $('#voice-call-bg').style.backgroundImage = `url(${avatarUrl})`;
            $('#voice-call-name').textContent = character.name;
            $('#voice-call-status-box').innerHTML = `<p>正在连接...</p>`;
            
            screen.classList.add('visible');
            startCallTimer($('#voice-call-timer'));
            getAICallResponse('voice');
        }

        function startVideoCall() {
            const character = characters.find(c => c.id === currentChatCharacterId);
            if (!character) return;
            
            currentCallType = 'video';
            const screen = $('#video-call-screen');
            const aiVideoImageUrl = userVideoImages[currentChatCharacterId] || character.avatar || 'https://placehold.co/375x720/111/FFF?text=BG';
            $('#video-call-bg').style.backgroundImage = `url(${aiVideoImageUrl})`;
            
            const myVideoImageUrl = myVideoImages[currentChatCharacterId] || 'https://placehold.co/180x240/333/FFF?text=Me';
            $('#user-video-image').src = myVideoImageUrl;

            $('#video-call-status-box').innerHTML = `<p>正在连接...</p>`;
            
            screen.classList.add('visible');
            getAICallResponse('video');
        }

        function endCall() {
            $('#voice-call-screen').classList.remove('visible');
            $('#video-call-screen').classList.remove('visible');
            clearInterval(callTimerInterval);
            
            const callDuration = $('#voice-call-timer').textContent;
            const message = currentCallType === 'voice' ? `语音通话已结束，时长 ${callDuration}` : '视频通话已结束';
            appendMessage(message, 'system', 'system', true);
            
            currentCallType = null;
        }
        
        function handleCallInteraction(type) {
            const inputBox = $(`#${type}-call-input`);
            const statusBox = $(`#${type}-call-status-box`);
            const message = inputBox.value.trim();
            if (message) {
                const p = document.createElement('p');
                p.textContent = `你: ${message}`;
                statusBox.appendChild(p);
                inputBox.value = '';
                statusBox.scrollTop = statusBox.scrollHeight;
            }
        }

        function triggerIncomingCall(type) {
            const character = characters.find(c => c.id === currentChatCharacterId);
            if (!character) return;

            currentCallType = type;
            const alertBox = $('#incoming-call-alert');
            $('#incoming-call-avatar').src = character.avatar || 'https://placehold.co/96x96/777/FFF?text=?';
            $('#incoming-call-name').textContent = character.name;
            $('#incoming-call-type').textContent = type === 'voice' ? '语音通话' : '视频通话';
            
            alertBox.classList.add('visible');
        }


        // 初始化與事件監聽器
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAllSavedData();
            updateTime();
            setInterval(updateTime, 60000);
            showScreen('home-screen');

            $('#theme-toggle').addEventListener('click', toggleTheme);
            $$('.app-icon').forEach(icon => {
                icon.addEventListener('click', () => {
                    const appName = icon.dataset.appName;
                    if (appName === "微信") {
                        renderWeChatList();
                        showScreen('wechat-list-screen');
                    }
                    else if (appName === "世界书") { renderWorldBookList(); showScreen('world-book-list-screen'); }
                    else if (appName === "角色书") { renderCharacterBookList(); showScreen('character-book-list-screen'); }
                    else if (appName === "设置") showScreen('main-settings-screen');
                });
            });
            
            $('#wechat-list-back-button').addEventListener('click', () => showScreen('home-screen'));
            $('#wechat-chat-back-button').addEventListener('click', () => {
                renderWeChatList();
                showScreen('wechat-list-screen');
            });
            $('#main-settings-back-button').addEventListener('click', () => showScreen('home-screen'));
            $('#api-settings-back-button').addEventListener('click', () => showScreen('main-settings-screen'));
            $('#api-settings-link').addEventListener('click', () => showScreen('api-settings-screen'));
            $('#wb-list-back-button').addEventListener('click', () => showScreen('home-screen'));
            $('#wb-edit-back-button').addEventListener('click', () => { renderWorldBookList(); showScreen('world-book-list-screen'); });
            $('#cb-list-back-button').addEventListener('click', () => showScreen('home-screen'));
            $('#cb-edit-back-button').addEventListener('click', () => { renderCharacterBookList(); showScreen('character-book-list-screen'); });
            $('#beautify-settings-link').addEventListener('click', () => showScreen('beautify-settings-screen'));
            $('#beautify-settings-back-button').addEventListener('click', () => showScreen('main-settings-screen'));
            $('#change-app-icons-link').addEventListener('click', () => {
                renderAppIconSettings();
                showScreen('app-icon-settings-screen');
            });
            $('#app-icon-settings-back-button').addEventListener('click', () => showScreen('beautify-settings-screen'));
            $('#font-settings-link').addEventListener('click', () => showScreen('font-settings-screen'));
            $('#font-settings-back-button').addEventListener('click', () => showScreen('main-settings-screen'));

            $('#music-block').addEventListener('click', (e) => { if (e.target === e.currentTarget) $('#background-input').click(); });
            $('#background-input').addEventListener('change', (e) => handleImageUpload(e.target, $('#music-block'), 'saved_music_background'));
            $('#vinyl-record').addEventListener('click', () => $('#vinyl-input').click());
            $('#vinyl-input').addEventListener('change', (e) => handleImageUpload(e.target, $('#vinyl-record'), 'saved_vinyl_cover'));
            $('#photo-widget').addEventListener('click', () => $('#photo-widget-input').click());
            $('#photo-widget-input').addEventListener('change', (e) => handleImageUpload(e.target, $('#photo-widget'), 'saved_photo_widget', { hideTextElement: '#photo-widget-text' }));
            $('#widget-image-placeholder').addEventListener('click', () => $('#widget-image-input').click());
            $('#widget-image-input').addEventListener('change', (e) => handleImageUpload(e.target, $('#widget-image-placeholder'), 'saved_widget_image'));
            $('#character-avatar-placeholder').addEventListener('click', () => $('#character-avatar-input').click());
            $('#character-avatar-input').addEventListener('change', (e) => handleImageUpload(e.target, $('#character-avatar-placeholder'), null, { compression: { maxWidth: 256, maxHeight: 256 } }));

            $('#mood-text').addEventListener('input', (e) => saveData('saved_mood_text', e.target.value));
            $('#widget-name-input').addEventListener('input', (e) => saveData('saved_widget_name', e.target.value));
            $('#widget-thinking-input').addEventListener('input', (e) => saveData('saved_widget_thinking', e.target.value));
            $('#widget-location-input').addEventListener('input', (e) => saveData('saved_widget_location', e.target.value));

            $('#music-upload-button').addEventListener('click', () => $('#music-upload-input').click());
            $('#music-upload-input').addEventListener('change', (e) => {
                const files = e.target.files;
                if (files.length > 0) {
                    const newSongs = Array.from(files).map(file => ({ name: file.name, url: URL.createObjectURL(file) }));
                    songList = [...songList, ...newSongs];
                    const savableList = songList.map(s => ({name: s.name}));
                    saveData('songList', savableList);
                    updateSongListUI();
                    if (currentSongIndex === -1 && songList.length > 0) playSong(0);
                }
            });
            $('#playlist-button').addEventListener('click', () => $('#song-list-modal').style.display = 'flex');
            $('#close-playlist-modal').addEventListener('click', () => $('#song-list-modal').style.display = 'none');
            $('#play-pause-button').addEventListener('click', () => {
                if (songList.length === 0) return showMessageBox('请先上传歌曲');
                if (currentAudio.paused) {
                    if (currentSongIndex === -1) playSong(0);
                    else {
                        currentAudio.play();
                        startSpinning();
                    }
                } else {
                    currentAudio.pause();
                    stopSpinning();
                }
                $('#play-pause-button i').className = `fas ${currentAudio.paused ? 'fa-play' : 'fa-pause'} text-xl`;
            });
            $('#prev-button').addEventListener('click', () => { if (songList.length > 0) playSong((currentSongIndex - 1 + songList.length) % songList.length); });
            $('#next-button').addEventListener('click', () => { if (songList.length > 0) playSong((currentSongIndex + 1) % songList.length); });
            $('#loop-button').addEventListener('click', () => { isLooping = !isLooping; $('#loop-button').classList.toggle('active', isLooping); showMessageBox(isLooping ? '列表循环已开启' : '列表循环已关闭'); });
            $('#single-loop-button').addEventListener('click', () => { isSingleLooping = !isSingleLooping; $('#single-loop-button').classList.toggle('active', isSingleLooping); showMessageBox(isSingleLooping ? '单曲循环已开启' : '单曲循环已关闭'); });

            $('#wb-add-button').addEventListener('click', () => {
                currentEditingWorldBookId = null;
                $('#wb-title-input').value = '';
                $('#wb-content-input').value = '';
                showScreen('world-book-edit-screen');
            });
            $('#wb-save-button').addEventListener('click', () => {
                const title = $('#wb-title-input').value.trim();
                if (!title) return showMessageBox('标题不能为空');
                const content = $('#wb-content-input').value.trim();
                
                if (currentEditingWorldBookId) {
                    const book = worldBooks.find(b => b.id === currentEditingWorldBookId);
                    if (book) {
                        book.title = title;
                        book.content = content;
                    }
                } else {
                    const newBook = { id: `wb_${Date.now()}`, title, content };
                    worldBooks.push(newBook);
                }
                saveData('worldBooks', worldBooks);
                renderWorldBookList();
                showMessageBox('已保存');
                showScreen('world-book-list-screen');
            });

            $('#cb-add-button').addEventListener('click', () => {
                showCharacterEditScreen(null);
            });
            $('#cb-save-button').addEventListener('click', saveCharacter);
            $('#cb-delete-button').addEventListener('click', () => {
                if (currentEditingCharacterId) {
                    const character = characters.find(c => c.id === currentEditingCharacterId);
                    if (character) {
                        showDeleteConfirmation('character', character.id, character.name);
                    }
                }
            });
            
            $('#send-chat-button').addEventListener('click', handleSendMessage);
            $('#receive-chat-button').addEventListener('click', handleReceiveMessage);
            
            $('#wechat-new-chat-button').addEventListener('click', () => {
                const container = $('#new-chat-character-list');
                container.innerHTML = '';
                if (characters.length === 0) {
                    container.innerHTML = '<li class="p-3 text-center text-gray-400">请先去角色书创建角色</li>';
                } else {
                    characters.forEach(char => {
                        const item = document.createElement('li');
                        item.className = 'list-item';
                        const avatarStyle = char.avatar ? `background-image: url(${char.avatar})` : '';
                        const avatarContent = char.avatar ? '' : '<i class="fas fa-user text-xl"></i>';
                        item.innerHTML = `
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full mr-3 bg-zinc-600 flex-shrink-0 flex items-center justify-center bg-cover bg-center" style="${avatarStyle}">${avatarContent}</div>
                                <h4 class="font-semibold">${char.name}</h4>
                            </div>
                        `;
                        item.addEventListener('click', () => {
                            $('#new-chat-modal').style.display = 'none';
                            if (!chatHistories[char.id]) {
                                chatHistories[char.id] = { history: [], pinned: false };
                                saveData('chatHistories', chatHistories);
                                renderWeChatList();
                                showMessageBox(`已和 ${char.name} 建立对话`);
                            }
                        });
                        container.appendChild(item);
                    });
                }
                $('#new-chat-modal').style.display = 'flex';
            });
            $('#close-new-chat-modal').addEventListener('click', () => $('#new-chat-modal').style.display = 'none');
            
            $('#wechat-options-button').addEventListener('click', () => {
                const pinOption = $('#pin-chat-option');
                pinOption.textContent = chatHistories[currentChatCharacterId]?.pinned ? '取消置顶' : '置顶对话';
                
                const userColorPicker = $('#user-bubble-color-picker');
                const aiColorPicker = $('#ai-bubble-color-picker');
                const currentColors = chatBubbleColors[currentChatCharacterId];
                
                const isDarkMode = body.classList.contains('dark-mode');
                const defaultUserColor = isDarkMode ? '#db2777' : '#f9a8d4';
                const defaultAiColor = isDarkMode ? '#4a4a4a' : '#e5e7eb';

                userColorPicker.value = currentColors?.user || defaultUserColor;
                aiColorPicker.value = currentColors?.ai || defaultAiColor;

                showScreen('wechat-options-screen');
            });
            $('#wechat-options-back-button').addEventListener('click', () => showScreen('wechat-chat-screen'));
            $('#delete-chat-option').addEventListener('click', () => {
                const characterName = characters.find(c => c.id === currentChatCharacterId)?.name;
                showDeleteConfirmation('chat', currentChatCharacterId, `与 ${characterName} 的对话`);
            });
            $('#pin-chat-option').addEventListener('click', () => {
                const chat = chatHistories[currentChatCharacterId];
                if (chat) {
                    chat.pinned = !chat.pinned;
                    saveData('chatHistories', chatHistories);
                    showMessageBox(chat.pinned ? '已置顶' : '已取消置顶');
                    $('#pin-chat-option').textContent = chat.pinned ? '取消置顶' : '置顶对话';
                }
            });
            $('#change-chat-bg-option').addEventListener('click', () => {
                $('#chat-bg-input').click();
            });
            $('#chat-bg-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if(file && currentChatCharacterId) {
                    try {
                        const compressedDataUrl = await handleImageUpload(e.target, null, null);
                        chatBackgrounds[currentChatCharacterId] = compressedDataUrl;
                        saveData('chatBackgrounds', chatBackgrounds);

                        const chatScreen = $('#wechat-chat-screen');
                        chatScreen.querySelector('.chat-background').style.backgroundImage = `url(${compressedDataUrl})`;
                        
                        chatScreen.classList.add('has-custom-bg');
                        statusBar.classList.add('transparent-override');

                        showMessageBox('聊天背景已更换');
                    } catch (error) {
                        showMessageBox('背景图片处理失败');
                    }
                }
            });

            function handleColorChange(type, value) {
                if (!currentChatCharacterId) return;
                if (!chatBubbleColors[currentChatCharacterId]) {
                    chatBubbleColors[currentChatCharacterId] = {};
                }
                chatBubbleColors[currentChatCharacterId][type] = value;
                saveData('chatBubbleColors', chatBubbleColors);
                renderChatHistory();
            }
            $('#user-bubble-color-picker').addEventListener('input', (e) => handleColorChange('user', e.target.value));
            $('#ai-bubble-color-picker').addEventListener('input', (e) => handleColorChange('ai', e.target.value));

            
            $('#wechat-content-chat').addEventListener('click', (e) => {
                if (e.target.closest('.user-avatar-in-chat')) {
                    $('#user-avatar-input').click();
                }
            });
            $('#user-avatar-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file && currentChatCharacterId) {
                    const compressedDataUrl = await handleImageUpload(e.target, null, null, { compression: { maxWidth: 128, maxHeight: 128 } });
                    if (compressedDataUrl) {
                        userAvatars[currentChatCharacterId] = compressedDataUrl;
                        saveData('userAvatars', userAvatars);
                        renderChatHistory();
                    }
                }
                e.target.value = '';
            });

            $('#change-wallpaper-link').addEventListener('click', () => $('#wallpaper-input').click());
            $('#wallpaper-input').addEventListener('change', (e) => handleImageUpload(e.target, homeWallpaper, 'saved_wallpaper'));

            function renderAppIconSettings() {
                const container = $('#app-icon-list');
                container.innerHTML = '';
                $$('.app-icon').forEach(iconEl => {
                    const appName = iconEl.dataset.appName;
                    const item = document.createElement('div');
                    item.className = 'list-item'; 
                    
                    const innerContainer = document.createElement('div');
                    innerContainer.className = 'flex justify-between items-center w-full';

                    const leftPart = document.createElement('div');
                    leftPart.className = 'flex items-center';

                    const previewIcon = document.createElement('div');
                    previewIcon.className = 'w-10 h-10 rounded-lg flex items-center justify-center shadow-md mr-4 bg-cover bg-center';
                    
                    const savedIcon = loadData(`saved_icon_${appName}`);
                    if (savedIcon) {
                        previewIcon.style.backgroundImage = `url(${savedIcon})`;
                        previewIcon.style.backgroundSize = 'contain';
                        previewIcon.style.backgroundRepeat = 'no-repeat';
                    } else {
                        previewIcon.style.backgroundImage = iconEl.style.backgroundImage;
                    }

                    if (!previewIcon.style.backgroundImage) {
                        if (iconEl.classList.contains('app-icon-glass')) {
                            previewIcon.className += ' app-icon-glass';
                        } else {
                             previewIcon.style.backgroundColor = '#1f2937';
                        }
                    }
                    
                    const iconI = document.createElement('i');
                    const originalIcon = iconEl.querySelector('i');
                    if (originalIcon) iconI.className = originalIcon.className;
                    iconI.style.display = savedIcon ? 'none' : (originalIcon ? originalIcon.style.display : 'block');
                    previewIcon.appendChild(iconI);

                    const text = document.createElement('h4');
                    text.className = 'font-semibold';
                    text.textContent = appName;

                    leftPart.appendChild(previewIcon);
                    leftPart.appendChild(text);

                    const button = document.createElement('button');
                    button.className = 'px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded-md text-sm flex-shrink-0';
                    button.textContent = '更换';

                    innerContainer.appendChild(leftPart);
                    innerContainer.appendChild(button);
                    item.appendChild(innerContainer);
                    
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.className = 'hidden';
                    input.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            try {
                                const compressedDataUrl = await compressImage(file, { maxWidth: 128, maxHeight: 128 });
                                saveData(`saved_icon_${appName}`, compressedDataUrl);
                                iconEl.style.backgroundImage = `url(${compressedDataUrl})`;
                                if (originalIcon) originalIcon.style.display = 'none';
                                previewIcon.style.backgroundImage = `url(${compressedDataUrl})`;

                                iconEl.style.backgroundSize = 'contain';
                                iconEl.style.backgroundRepeat = 'no-repeat';
                                previewIcon.style.backgroundSize = 'contain';
                                previewIcon.style.backgroundRepeat = 'no-repeat';
                                
                                const previewIconI = previewIcon.querySelector('i');
                                if (previewIconI) previewIconI.style.display = 'none';
                            } catch (error) {
                                showMessageBox("图标处理失败");
                            }
                        }
                    });
                    item.appendChild(input);
                    button.addEventListener('click', () => input.click());
                    container.appendChild(item);
                });
            }
            
            $('#font-save-button').addEventListener('click', () => {
                const url = $('#font-url-input').value.trim();
                if (url) {
                    applyFont(url);
                    saveData('saved_font_url', url);
                    showMessageBox('字体已应用');
                } else {
                    const styleElement = document.getElementById('custom-font-style');
                    if(styleElement) styleElement.innerHTML = '';
                    phoneScreen.style.fontFamily = '';
                    localStorage.removeItem('saved_font_url');
                    showMessageBox('已恢复默认字体');
                }
            });

            $('#font-size-selector').addEventListener('click', (e) => {
                if (e.target.matches('.font-size-btn')) {
                    const size = e.target.dataset.size;
                    setFontSize(size);
                    saveData('fontSize', size);
                }
            });
            
            $('#fetch_models_btn').addEventListener('click', () => fetchModels(false));

            $('#save_settings_btn').addEventListener('click', async () => {
                const apiUrl = $('#api_url').value.trim();
                const apiKey = $('#api_key').value.trim();
                let model = $('#model_select').value;

                if (!apiUrl || !apiKey) {
                    showMessageBox("请填写 API 地址和密钥");
                    return;
                }
                
                const settings = { url: apiUrl, key: apiKey, model: model };
                saveData('api_settings', settings);
                showMessageBox("设定已保存，正在验证连接...");

                const isValid = await fetchModels(true);
                updateApiStatusUI(isValid);

                if (isValid) {
                    showMessageBox("API 验证成功");
                    settings.model = $('#model_select').value;
                    saveData('api_settings', settings);
                } else {
                    showMessageBox("API 验证失败，请检查地址和密钥");
                }
            });

            $('#confirm-delete-btn').addEventListener('click', () => {
                if (deleteCallback) deleteCallback();
            });
            $('#cancel-delete-btn').addEventListener('click', () => {
                $('#confirm-delete-modal').style.display = 'none';
                deleteCallback = null;
            });
            
            $('.wechat-tab-bar').addEventListener('click', (e) => {
                const target = e.target.closest('.wechat-tab-item');
                if (!target) return;

                $$('.wechat-tab-item').forEach(item => item.classList.remove('active'));
                target.classList.add('active');

                const tab = target.dataset.tab;
                if (tab !== 'chat') {
                    showMessageBox('此功能正在开发中...');
                }
            });
            
            const chatScreen = $('#wechat-chat-screen');

            function hideBubbleMenu() {
                if (activeMenu) {
                    activeMenu.classList.remove('visible');
                    activeMenu = null;
                }
            }

            chatScreen.addEventListener('click', (e) => {
                const menu = e.target.closest('.bubble-context-menu');
                if (menu) return;

                const wrapper = e.target.closest('.chat-message-wrapper');
                
                if (isMultiSelectMode) {
                    if (wrapper) {
                        toggleMessageSelection(wrapper);
                    }
                } else {
                    const bubble = e.target.closest('.chat-message');
                    if (bubble) {
                        e.stopPropagation();
                        if (activeMenu && !activeMenu.isSameNode(bubble.parentNode.querySelector('.bubble-context-menu'))) {
                           hideBubbleMenu();
                        }
                        showBubbleMenu(bubble);
                    } else {
                        hideBubbleMenu();
                    }
                }
            });
            
            function showBubbleMenu(bubble) {
                const wrapper = bubble.closest('.chat-message-wrapper');
                let menu = wrapper.querySelector('.bubble-context-menu');

                if (!menu) {
                    const template = $('#bubble-menu-template');
                    const menuClone = template.content.cloneNode(true);
                    wrapper.appendChild(menuClone);
                    menu = wrapper.querySelector('.bubble-context-menu');

                    menu.addEventListener('click', (e) => {
                        const button = e.target.closest('.bubble-menu-button');
                        if (button) {
                            const action = button.dataset.action;
                            const timestamp = wrapper.dataset.timestamp;
                            handleMenuAction(action, timestamp, bubble);
                        }
                    });
                }
                
                const sender = wrapper.dataset.sender;
                
                menu.querySelector('[data-action="retry"]').style.display = sender === 'ai' ? 'flex' : 'none';
                
                const bubbleRect = bubble.getBoundingClientRect();
                const screenRect = phoneScreen.getBoundingClientRect();
                
                menu.classList.add('visible');
                const menuRect = menu.getBoundingClientRect();
                
                let top = bubble.offsetTop - menuRect.height - 8;
                
                if (bubbleRect.top < (screenRect.top + menuRect.height + 16)) {
                    top = bubble.offsetTop + bubble.offsetHeight + 8;
                }
                
                const leftOffset = (bubble.offsetWidth / 2) - (menuRect.width / 2);
                let finalLeft = bubble.offsetLeft + leftOffset;

                menu.style.top = `${top}px`;
                menu.style.left = `${finalLeft}px`;
                menu.style.transform = 'translateX(0)';

                activeMenu = menu;
            }

            function handleMenuAction(action, timestamp, bubble) {
                 hideBubbleMenu();
                 switch (action) {
                    case 'delete':
                        showDeleteConfirmation('message', timestamp, '这条消息');
                        break;
                    case 'copy':
                        copyMessageHandler(timestamp);
                        break;
                    case 'multiselect':
                        enterMultiSelectMode();
                        break;
                    case 'edit':
                        editMessageHandler(timestamp, bubble);
                        break;
                    case 'retry':
                        retryMessageHandler(timestamp);
                        break;
                 }
            }

            function copyMessageHandler(timestamp) {
                const msg = chatHistories[currentChatCharacterId]?.history.find(m => String(m.timestamp) === timestamp);
                if (msg && msg.type === 'text') {
                    navigator.clipboard.writeText(msg.content).then(() => {
                        showMessageBox('已复制');
                    }).catch(() => showMessageBox('复制失败'));
                }
            }

            function editMessageHandler(timestamp, bubble) {
                const msgIndex = chatHistories[currentChatCharacterId].history.findIndex(m => String(m.timestamp) === timestamp);
                if (msgIndex === -1 || chatHistories[currentChatCharacterId].history[msgIndex].type !== 'text') return;

                const p = bubble.querySelector('p');
                const originalText = chatHistories[currentChatCharacterId].history[msgIndex].content;
                p.contentEditable = true;
                p.focus();
                
                const sel = window.getSelection();
                sel.selectAllChildren(p);
                sel.collapseToEnd();

                const saveEdit = () => {
                    const newText = p.innerText.trim();
                    if (newText && newText !== originalText) {
                        chatHistories[currentChatCharacterId].history[msgIndex].content = newText;
                        saveData('chatHistories', chatHistories);
                    }
                    p.innerHTML = newText.replace(/(\*|_)(.*?)\1/g, '<i>$2</i>');
                };

                p.addEventListener('blur', () => {
                    p.contentEditable = false;
                    saveEdit();
                }, { once: true });

                p.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); p.blur(); }
                    if (e.key === 'Escape') { p.innerText = originalText; p.blur(); }
                });
            }

            async function retryMessageHandler(timestamp) {
                const history = chatHistories[currentChatCharacterId].history;
                const msgIndex = history.findIndex(m => String(m.timestamp) === timestamp);
                
                if (msgIndex > -1) {
                    const historyToRetry = history.slice(0, msgIndex);
                    if (historyToRetry.length > 0 && historyToRetry[historyToRetry.length - 1].sender === 'user') {
                        chatHistories[currentChatCharacterId].history = historyToRetry;
                        saveData('chatHistories', chatHistories);
                        renderChatHistory();
                        await getAIResponse(historyToRetry[historyToRetry.length-1], true);
                    } else {
                        showMessageBox('无法找到有效的重试上下文');
                    }
                }
            }
            
            function enterMultiSelectMode() {
                isMultiSelectMode = true;
                $('#chat-header-normal').classList.add('hidden');
                $('#chat-header-multiselect').classList.remove('hidden');
                $('#chat-header-multiselect').classList.add('flex');
                updateMultiSelectCount();
            }

            function exitMultiSelectMode() {
                isMultiSelectMode = false;
                selectedMessages.clear();
                $$('.chat-message-wrapper.selected').forEach(el => el.classList.remove('selected'));
                $('#chat-header-normal').classList.remove('hidden');
                $('#chat-header-multiselect').classList.add('hidden');
                $('#chat-header-multiselect').classList.remove('flex');
            }
            
            function toggleMessageSelection(wrapper) {
                const timestamp = wrapper.dataset.timestamp;
                wrapper.classList.toggle('selected');
                if (selectedMessages.has(timestamp)) {
                    selectedMessages.delete(timestamp);
                } else {
                    selectedMessages.add(timestamp);
                }
                updateMultiSelectCount();
            }

            function updateMultiSelectCount() {
                const count = selectedMessages.size;
                $('#multiselect-count').textContent = `已选择 ${count} 项`;
                $('#confirm-multiselect-btn').disabled = count === 0;
            }

            $('#cancel-multiselect-btn').addEventListener('click', exitMultiSelectMode);
            $('#confirm-multiselect-btn').addEventListener('click', () => {
                if(selectedMessages.size > 0) {
                    showDeleteConfirmation('multi-message', null, `${selectedMessages.size}条消息`);
                }
            });

            const featuresPanel = $('#more-features-panel');
            const addFeatureBtn = $('#add-feature-btn');
            const chatInputBar = $('#chat-input-bar');
            const chatInput = $('#chat-input');
            const addFeatureIcon = addFeatureBtn.querySelector('i');
            
            function toggleFeaturesPanel() {
                const isPanelHidden = featuresPanel.classList.contains('hidden');
                if (isPanelHidden) {
                    featuresPanel.classList.remove('hidden');
                    chatInputBar.classList.add('hidden');
                    addFeatureIcon.className = 'ri-keyboard-line';
                } else {
                    featuresPanel.classList.add('hidden');
                    chatInputBar.classList.remove('hidden');
                    addFeatureIcon.className = 'ri-add-circle-line';
                }
            }

            addFeatureBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFeaturesPanel();
            });

            chatScreen.addEventListener('click', (e) => {
                if (addFeatureBtn.contains(e.target) || featuresPanel.contains(e.target)) return;
                if (!featuresPanel.classList.contains('hidden')) {
                    toggleFeaturesPanel();
                }
            });

            $('#send-image-btn').addEventListener('click', () => {
                $('#image-upload-input').click();
            });

            $('#image-upload-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const compressedDataUrl = await handleImageUpload(e.target, null, null, { compression: { maxWidth: 512, maxHeight: 512 } });
                    if (compressedDataUrl) {
                        const isNewSender = chatHistories[currentChatCharacterId]?.history.length === 0 || chatHistories[currentChatCharacterId].history.slice(-1)[0].sender !== 'user';
                        const timestamp = Date.now();
                        appendMessage(compressedDataUrl, 'user', 'image', true, timestamp, isNewSender);
                        await getAIResponse({ content: compressedDataUrl, type: 'image' });
                    }
                    toggleFeaturesPanel();
                    e.target.value = ''; 
                }
            });

            $('#emoji-btn').addEventListener('click', () => showMessageBox('表情功能开发中'));
            
            const voiceModal = $('#voice-input-modal');
            const voiceInput = $('#voice-text-input');
            $('#quick-voice-message-btn').addEventListener('click', () => {
                voiceModal.style.display = 'flex';
                voiceInput.focus();
            });
            $('#cancel-voice-btn').addEventListener('click', () => {
                voiceModal.style.display = 'none';
                voiceInput.value = '';
            });
            $('#send-voice-btn').addEventListener('click', () => {
                const text = voiceInput.value.trim();
                if (text) {
                    const isNewSender = chatHistories[currentChatCharacterId]?.history.length === 0 || chatHistories[currentChatCharacterId].history.slice(-1)[0].sender !== 'user';
                    appendMessage(text, 'user', 'voice', true, Date.now(), isNewSender);
                    voiceInput.value = '';
                    voiceModal.style.display = 'none';
                }
            });

            $('#quick-voice-call-btn').addEventListener('click', () => {
                currentCallType = 'voice';
                startVoiceCall();
            });
            $('#quick-video-call-btn').addEventListener('click', () => {
                currentCallType = 'video';
                startVideoCall();
            });

            $('#voice-call-hangup').addEventListener('click', endCall);
            $('#video-call-hangup').addEventListener('click', endCall);
            $('#voice-call-send-btn').addEventListener('click', () => handleCallInteraction('voice'));
            $('#video-call-send-btn').addEventListener('click', () => handleCallInteraction('video'));

            $('#answer-call-btn').addEventListener('click', () => {
                $('#incoming-call-alert').classList.remove('visible');
                if (currentCallType === 'voice') startVoiceCall();
                if (currentCallType === 'video') startVideoCall();
            });
            $('#decline-call-btn').addEventListener('click', () => {
                $('#incoming-call-alert').classList.remove('visible');
                appendMessage('通话已拒绝', 'system', 'system', true);
                currentCallType = null;
            });

            $('#user-video-preview').addEventListener('click', () => {
                $('#my-video-image-input').click();
            });

            $('#change-user-video-image-option').addEventListener('click', () => {
                 $('#user-video-image-input').click();
            });
            
            $('#user-video-image-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file && currentChatCharacterId) {
                    const compressedDataUrl = await handleImageUpload(e.target, null, null, { compression: { maxWidth: 512, maxHeight: 512 }});
                    if (compressedDataUrl) {
                        userVideoImages[currentChatCharacterId] = compressedDataUrl;
                        saveData('userVideoImages', userVideoImages);
                        showMessageBox('对方的视频照片已更新');
                    }
                }
            });

            $('#my-video-image-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file && currentChatCharacterId) {
                    const compressedDataUrl = await handleImageUpload(e.target, null, null, { compression: { maxWidth: 256, maxHeight: 256 }});
                    if (compressedDataUrl) {
                        myVideoImages[currentChatCharacterId] = compressedDataUrl;
                        saveData('myVideoImages', myVideoImages);
                        if (currentCallType === 'video') {
                            $('#user-video-image').src = compressedDataUrl;
                        }
                        showMessageBox('我的视频照片已更新');
                    }
                }
            });
            
            $$('.feature-item').forEach(item => {
                if (!['send-image-btn'].includes(item.id)) {
                    item.addEventListener('click', () => {
                        const featureName = item.querySelector('span').textContent;
                        showMessageBox(`${featureName}功能开发中`);
                    });
                }
            });

            let initialTextareaHeight = 0;
            let maxHeight = 0;

            function adjustTextareaHeight() {
                if (!initialTextareaHeight) {
                    const style = window.getComputedStyle(chatInput);
                    const lineHeight = parseFloat(style.lineHeight);
                    const paddingTop = parseFloat(style.paddingTop);
                    const paddingBottom = parseFloat(style.paddingBottom);
                    initialTextareaHeight = lineHeight;
                    maxHeight = (lineHeight * 3) + paddingTop + paddingBottom;
                }
                
                chatInput.style.height = 'auto';
                const scrollHeight = chatInput.scrollHeight;

                if (scrollHeight > maxHeight) {
                    chatInput.style.height = `${maxHeight}px`;
                    chatInput.style.overflowY = 'auto';
                } else {
                    chatInput.style.height = `${scrollHeight}px`;
                    chatInput.style.overflowY = 'hidden';
                }
            }

            chatInput.addEventListener('input', adjustTextareaHeight);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });

        });
    </script>
</body>
</html>
